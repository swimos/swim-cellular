// swim-mesh-3.11.0-dev.20200517; copyright 2015-2020 SWIM.AI inc.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@swim/codec"),require("@swim/recon"),require("@swim/util"),require("@swim/uri"),require("@swim/structure"),require("@swim/collections"),require("@swim/streamlet"),require("@swim/dataflow")):"function"==typeof define&&define.amd?define(["exports","@swim/codec","@swim/recon","@swim/util","@swim/uri","@swim/structure","@swim/collections","@swim/streamlet","@swim/dataflow"],e):e((t=t||self).swim=t.swim||{},t.swim,t.swim,t.swim,t.swim,t.swim,t.swim,t.swim,t.swim)}(this,(function(t,e,o,i,n,r,s,h,u){"use strict";var l=function(){function t(){}return t.prototype.tag=function(){return this.constructor.tag()},t.prototype.prio=function(t){return void 0===t?0:this},t.prototype.rate=function(t){return void 0===t?0:this},t.prototype.toRecon=function(){return o.Recon.toString(this.toValue())},t.prototype.toString=function(){return e.Format.debug(this)},t.tag=function(){},t.fromValue=function(e){switch(e.tag()){case"event":return t.EventMessage.fromValue(e);case"command":return t.CommandMessage.fromValue(e);case"link":return t.LinkRequest.fromValue(e);case"linked":return t.LinkedResponse.fromValue(e);case"sync":return t.SyncRequest.fromValue(e);case"synced":return t.SyncedResponse.fromValue(e);case"unlink":return t.UnlinkRequest.fromValue(e);case"unlinked":return t.UnlinkedResponse.fromValue(e);case"auth":return t.AuthRequest.fromValue(e);case"authed":return t.AuthedResponse.fromValue(e);case"deauth":return t.DeauthRequest.fromValue(e);case"deauthed":return t.DeauthedResponse.fromValue(e);default:return}},t.parseRecon=function(e){return t.fromValue(o.Recon.parse(e))},t}(),a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};function p(t,e){function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}function d(t,e,o,i){var n,r=arguments.length,s=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,i);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(s=(r<3?n(s):r>3?n(e,o,s):n(e,o))||s);return r>3&&s&&Object.defineProperty(e,o,s),s}function c(){for(var t=0,e=0,o=arguments.length;e<o;e++)t+=arguments[e].length;var i=Array(t),n=0;for(e=0;e<o;e++)for(var r=arguments[e],s=0,h=r.length;s<h;s++,n++)i[n]=r[s];return i}var f=function(t){function e(e){var o=t.call(this)||this;return o._body=e,o}return p(e,t),e.prototype.node=function(t){return void 0===t?n.Uri.empty():this},e.prototype.lane=function(t){return void 0===t?n.Uri.empty():this},e.prototype.body=function(t){return void 0===t?this._body:(t=r.Value.fromAny(t),this.copy(t))},e.prototype.equals=function(t){return this===t||t instanceof e&&this.__proto__.constructor===t.__proto__.constructor&&this._body.equals(t._body)},e.prototype.hashCode=function(){return i.Murmur3.mash(i.Murmur3.mix(i.Murmur3.seed(this.__proto__),this._body.hashCode()))},e.prototype.debug=function(t){t=t.write(this.__proto__.constructor.name).write(46).write("of").write(40),this._body.isDefined()&&(t=t.debug(this._body)),t=t.write(41)},e.prototype.toValue=function(){return r.Attr.of(this.tag()).concat(this._body)},e.fromValue=function(t,e){if(t.header(e.tag()).isDefined())return new e(t.body())},e}(l),v=function(t){function e(e,o,i){var n=t.call(this)||this;return n._node=e,n._lane=o,n._body=i,n}return p(e,t),e.prototype.node=function(t){return void 0===t?this._node:(t=n.Uri.fromAny(t),this.copy(t,this._lane,this._body))},e.prototype.lane=function(t){return void 0===t?this._lane:(t=n.Uri.fromAny(t),this.copy(this._node,t,this._body))},e.prototype.body=function(t){return void 0===t?this._body:(t=r.Value.fromAny(t),this.copy(this._node,this._lane,t))},e.prototype.toValue=function(){var t=r.Record.create(2).slot("node",this._node.toString()).slot("lane",this._lane.toString());return r.Attr.of(this.tag(),t).concat(this._body)},e.prototype.equals=function(t){return this===t||t instanceof e&&this.__proto__.constructor===t.__proto__.constructor&&(this._node.equals(t._node)&&this._lane.equals(t._lane)&&this._body.equals(t._body))},e.prototype.hashCode=function(){return i.Murmur3.mash(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.seed(this.__proto__),this._node.hashCode()),this._lane.hashCode()),this._body.hashCode()))},e.prototype.debug=function(t){t=t.write(this.__proto__.constructor.name).write(46).write("of").write(40).debug(this._node.toString()).write(", ").debug(this._lane.toString()),this._body.isDefined()&&(t=t.write(", ").debug(this._body)),t=t.write(41)},e.fromValue=function(t,e){var o,i;if(t.header(e.tag()).forEach((function(t,e){var s=t.key.stringValue(void 0);void 0!==s?"node"===s?o=n.Uri.parse(t.toValue().stringValue("")):"lane"===s&&(i=n.Uri.parse(t.toValue().stringValue(""))):t instanceof r.Value&&(0===e?o=n.Uri.parse(t.stringValue("")):1===e&&(i=n.Uri.parse(t.stringValue(""))))})),void 0!==o&&void 0!==i){var s=t.body();return new e(o,i,s)}},e}(l),_=function(t){function e(e,o,i,n,r){var s=t.call(this)||this;return s._node=e,s._lane=o,s._prio=i,s._rate=n,s._body=r,s}return p(e,t),e.prototype.node=function(t){return void 0===t?this._node:(t=n.Uri.fromAny(t),this.copy(t,this._lane,this._prio,this._rate,this._body))},e.prototype.lane=function(t){return void 0===t?this._lane:(t=n.Uri.fromAny(t),this.copy(this._node,t,this._prio,this._rate,this._body))},e.prototype.prio=function(t){return void 0===t?this._prio:this.copy(this._node,this._lane,t,this._rate,this._body)},e.prototype.rate=function(t){return void 0===t?this._rate:this.copy(this._node,this._lane,this._prio,t,this._body)},e.prototype.body=function(t){return void 0===t?this._body:(t=r.Value.fromAny(t),this.copy(this._node,this._lane,this._prio,this._rate,t))},e.prototype.equals=function(t){return this===t||t instanceof e&&this.__proto__.constructor===t.__proto__.constructor&&(this._node.equals(t._node)&&this._lane.equals(t._lane)&&this._prio===t._prio&&this._rate===t._rate&&this._body.equals(t._body))},e.prototype.hashCode=function(){return i.Murmur3.mash(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.mix(i.Murmur3.seed(this.__proto__),this._node.hashCode()),this._lane.hashCode()),i.Murmur3.hash(this._prio)),i.Murmur3.hash(this._rate)),this._body.hashCode()))},e.prototype.debug=function(t){t=t.write(this.__proto__.constructor.name).write(46).write("of").write(40).debug(this._node.toString()).write(", ").debug(this._lane.toString()),0===this._prio&&0===this._rate||(t=t.write(", ").debug(this._prio).write(", ").debug(this._rate)),this._body.isDefined()&&(t=t.write(", ").debug(this._body)),t=t.write(41)},e.prototype.toValue=function(){var t=r.Record.create(4).slot("node",this._node.toString()).slot("lane",this._lane.toString());return 0!==this._prio&&t.slot("prio",this._prio),0!==this._rate&&t.slot("rate",this._rate),r.Attr.of(this.tag(),t).concat(this._body)},e.fromValue=function(t,e){var o,i,s=0,h=0;if(t.header(e.tag()).forEach((function(t,e){var u=t.key.stringValue(void 0);void 0!==u?"node"===u?o=n.Uri.parse(t.toValue().stringValue("")):"lane"===u?i=n.Uri.parse(t.toValue().stringValue("")):"prio"===u?s=t.numberValue(s):"rate"===u&&(h=t.numberValue(h)):t instanceof r.Value&&(0===e?o=n.Uri.parse(t.stringValue("")):1===e&&(i=n.Uri.parse(t.stringValue(""))))})),void 0!==o&&void 0!==i){var u=t.body();return new e(o,i,s,h,u)}},e}(l),y=function(t){function e(e,o,i){return t.call(this,e,o,i)||this}return p(e,t),e.prototype.copy=function(t,o,i){return new e(t,o,i)},e.tag=function(){return"event"},e.fromValue=function(t){return v.fromValue(t,e)},e.of=function(t,o,i){return void 0===i&&(i=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i=r.Value.fromAny(i))},e}(v);l.EventMessage=y;var m=function(t){function e(e,o,i){return t.call(this,e,o,i)||this}return p(e,t),e.prototype.copy=function(t,o,i){return new e(t,o,i)},e.tag=function(){return"command"},e.fromValue=function(t){return v.fromValue(t,e)},e.of=function(t,o,i){return void 0===i&&(i=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i=r.Value.fromAny(i))},e}(v);l.CommandMessage=m;var w=function(t){function e(e,o,i,n,r){return t.call(this,e,o,i,n,r)||this}return p(e,t),e.prototype.copy=function(t,o,i,n,r){return new e(t,o,i,n,r)},e.tag=function(){return"link"},e.fromValue=function(t){return _.fromValue(t,e)},e.of=function(t,o,i,s,h){return void 0===i&&(i=0),void 0===s&&(s=0),void 0===h&&(h=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i,s,h=r.Value.fromAny(h))},e}(_);l.LinkRequest=w;var k=function(t){function e(e,o,i,n,r){return t.call(this,e,o,i,n,r)||this}return p(e,t),e.prototype.copy=function(t,o,i,n,r){return new e(t,o,i,n,r)},e.tag=function(){return"linked"},e.fromValue=function(t){return _.fromValue(t,e)},e.of=function(t,o,i,s,h){return void 0===i&&(i=0),void 0===s&&(s=0),void 0===h&&(h=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i,s,h=r.Value.fromAny(h))},e}(_);l.LinkedResponse=k;var g=function(t){function e(e,o,i,n,r){return t.call(this,e,o,i,n,r)||this}return p(e,t),e.prototype.copy=function(t,o,i,n,r){return new e(t,o,i,n,r)},e.tag=function(){return"sync"},e.fromValue=function(t){return _.fromValue(t,e)},e.of=function(t,o,i,s,h){return void 0===i&&(i=0),void 0===s&&(s=0),void 0===h&&(h=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i,s,h=r.Value.fromAny(h))},e}(_);l.SyncRequest=g;var b=function(t){function e(e,o,i){return t.call(this,e,o,i)||this}return p(e,t),e.prototype.copy=function(t,o,i){return new e(t,o,i)},e.tag=function(){return"synced"},e.fromValue=function(t){return v.fromValue(t,e)},e.of=function(t,o,i){return void 0===i&&(i=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i=r.Value.fromAny(i))},e}(v);l.SyncedResponse=b;var U=function(t){function e(e,o,i){return t.call(this,e,o,i)||this}return p(e,t),e.prototype.copy=function(t,o,i){return new e(t,o,i)},e.tag=function(){return"unlink"},e.fromValue=function(t){return v.fromValue(t,e)},e.of=function(t,o,i){return void 0===i&&(i=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i=r.Value.fromAny(i))},e}(v);l.UnlinkRequest=U;var D=function(t){function e(e,o,i){return t.call(this,e,o,i)||this}return p(e,t),e.prototype.copy=function(t,o,i){return new e(t,o,i)},e.tag=function(){return"unlinked"},e.fromValue=function(t){return v.fromValue(t,e)},e.of=function(t,o,i){return void 0===i&&(i=r.Value.absent()),new e(t=n.Uri.fromAny(t),o=n.Uri.fromAny(o),i=r.Value.fromAny(i))},e}(v);l.UnlinkedResponse=D;var R=function(t){function e(e){return t.call(this,e)||this}return p(e,t),e.prototype.copy=function(t){return new e(t)},e.tag=function(){return"auth"},e.fromValue=function(t){return f.fromValue(t,e)},e.of=function(t){return void 0===t&&(t=r.Value.absent()),new e(t=r.Value.fromAny(t))},e}(f);l.AuthRequest=R;var V=function(t){function e(e){return t.call(this,e)||this}return p(e,t),e.prototype.copy=function(t){return new e(t)},e.tag=function(){return"authed"},e.fromValue=function(t){return f.fromValue(t,e)},e.of=function(t){return void 0===t&&(t=r.Value.absent()),new e(t=r.Value.fromAny(t))},e}(f);l.AuthedResponse=V;var E=function(t){function e(e){return t.call(this,e)||this}return p(e,t),e.prototype.copy=function(t){return new e(t)},e.tag=function(){return"deauth"},e.fromValue=function(t){return f.fromValue(t,e)},e.of=function(t){return void 0===t&&(t=r.Value.absent()),new e(t=r.Value.fromAny(t))},e}(f);l.DeauthRequest=E;var F=function(t){function e(e){return t.call(this,e)||this}return p(e,t),e.prototype.copy=function(t){return new e(t)},e.tag=function(){return"deauthed"},e.fromValue=function(t){return f.fromValue(t,e)},e.of=function(t){return void 0===t&&(t=r.Value.absent()),new e(t=r.Value.fromAny(t))},e}(f);l.DeauthedResponse=F;var C,A=function(){},S=function(t){function e(e,o,i){void 0===i&&(i={});var h=t.call(this)||this;return h._context=e,h._hostUri=o,h._options=i,h._downlinks=new s.BTree,h._downlinkCount=0,h._authenticated=!1,h._session=r.Value.absent(),h._uriCache=new n.UriCache(o),h._sendBuffer=[],h._reconnectTimer=0,h._reconnectTimeout=0,h._idleTimer=0,h}return p(e,t),e.prototype.hostUri=function(){return this._hostUri},e.prototype.credentials=function(){return this._options.credentials||r.Value.absent()},e.prototype.unlinkDelay=function(){var t=this._options.unlinkDelay;return"number"==typeof t?t:0},e.prototype.maxReconnectTimeout=function(){return this._options.maxReconnectTimeout||3e4},e.prototype.idleTimeout=function(){return this._options.idleTimeout||1e3},e.prototype.sendBufferSize=function(){return this._options.sendBufferSize||1024},e.prototype.isAuthenticated=function(){return this._authenticated},e.prototype.session=function(){return this._session},e.prototype.isIdle=function(){return!this._sendBuffer.length&&!this._downlinkCount},e.prototype.resolve=function(t){return this._uriCache.resolve(t)},e.prototype.unresolve=function(t){return this._uriCache.unresolve(t)},e.prototype.authenticate=function(t){if(!(t=r.Value.fromAny(t)).equals(this._options.credentials))if(this._options.credentials=t,this.isConnected()){var e=R.of(t);this.push(e)}else this.open()},e.prototype.openDownlink=function(t){this.clearIdle();var e=this.resolve(t.nodeUri()),o=t.laneUri();0===this._downlinkCount&&this.open();var i=this._downlinks.get(e);if(void 0===i&&(i=new s.BTree,this._downlinks.set(e,i)),void 0!==i.get(o))throw new Error("duplicate downlink");i.set(o,t),this._downlinkCount+=1,t.openUp(this),this.isConnected()&&t.hostDidConnect(this)},e.prototype.unlinkDownlink=function(t){var e=this.resolve(t.nodeUri()),o=t.laneUri(),i=this._downlinks.get(e);if(void 0!==i&&i.get(o)&&this.isConnected()){var n=U.of(this.unresolve(e),o);t.onUnlinkRequest(n,this),this.push(n)}},e.prototype.closeDownlink=function(t){var e=this.resolve(t.nodeUri()),o=t.laneUri(),i=this._downlinks.get(e);void 0!==i&&i.get(o)&&(this._downlinkCount-=1,i.delete(o),i.isEmpty()&&this._downlinks.delete(e),0===this._downlinkCount&&this.watchIdle(),t.closeUp(this))},e.prototype.command=function(t,e,o){t=n.Uri.fromAny(t),t=this.resolve(t),e=n.Uri.fromAny(e),o=r.Value.fromAny(o);var i=m.of(this.unresolve(t),e,o);this.push(i)},e.prototype.onEnvelope=function(t){t instanceof y?this.onEventMessage(t):t instanceof m?this.onCommandMessage(t):t instanceof w?this.onLinkRequest(t):t instanceof k?this.onLinkedResponse(t):t instanceof g?this.onSyncRequest(t):t instanceof b?this.onSyncedResponse(t):t instanceof U?this.onUnlinkRequest(t):t instanceof D?this.onUnlinkedResponse(t):t instanceof R?this.onAuthRequest(t):t instanceof V?this.onAuthedResponse(t):t instanceof E?this.onDeauthRequest(t):t instanceof F?this.onDeauthedResponse(t):this.onUnknownEnvelope(t)},e.prototype.onEventMessage=function(t){var e=this.resolve(t.node()),o=t.lane(),i=this._downlinks.get(e);if(void 0!==i){var n=i.get(o);if(void 0!==n){var r=t.node(e);n.onEventMessage(r,this)}}},e.prototype.onCommandMessage=function(t){},e.prototype.onLinkRequest=function(t){},e.prototype.onLinkedResponse=function(t){var e=this.resolve(t.node()),o=t.lane(),i=this._downlinks.get(e);if(void 0!==i){var n=i.get(o);if(void 0!==n){var r=t.node(e);n.onLinkedResponse(r,this)}}},e.prototype.onSyncRequest=function(t){},e.prototype.onSyncedResponse=function(t){var e=this.resolve(t.node()),o=t.lane(),i=this._downlinks.get(e);if(void 0!==i){var n=i.get(o);if(void 0!==n){var r=t.node(e);n.onSyncedResponse(r,this)}}},e.prototype.onUnlinkRequest=function(t){},e.prototype.onUnlinkedResponse=function(t){var e=this.resolve(t.node()),o=t.lane(),i=this._downlinks.get(e);if(void 0!==i){var n=i.get(o);if(void 0!==n){var r=t.node(e);n.onUnlinkedResponse(r,this)}}},e.prototype.onAuthRequest=function(t){},e.prototype.onAuthedResponse=function(t){this._authenticated=!0,this._session=t.body(),this._context.hostDidAuthenticate(t.body(),this)},e.prototype.onDeauthRequest=function(t){},e.prototype.onDeauthedResponse=function(t){this._authenticated=!1,this._session=r.Value.absent(),this._context.hostDidDeauthenticate(t.body(),this)},e.prototype.onUnknownEnvelope=function(t){},e.prototype.onConnect=function(){this._reconnectTimeout=0,this._context.hostDidConnect(this),this._downlinks.forEach((function(t,e){e.forEach((function(t,e){e.hostDidConnect(this)}),this)}),this)},e.prototype.onDisconnect=function(){this._authenticated=!1,this._session=r.Value.absent(),this._context.hostDidDisconnect(this),this._downlinks.forEach((function(t,e){e.forEach((function(t,e){e.hostDidDisconnect(this)}),this)}),this)},e.prototype.onError=function(t){this._context.hostDidFail(t,this),this._downlinks.forEach((function(e,o){o.forEach((function(e,o){o.hostDidFail(t,this)}),this)}),this)},e.prototype.reconnect=function(){0===this._reconnectTimer&&(0===this._reconnectTimeout?this._reconnectTimeout=Math.floor(500+1e3*Math.random()):this._reconnectTimeout=Math.min(Math.floor(1.8*this._reconnectTimeout),this.maxReconnectTimeout()),this._reconnectTimer=setTimeout(this.open.bind(this),this._reconnectTimeout))},e.prototype.clearReconnect=function(){0!==this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=0)},e.prototype.watchIdle=function(){0===this._idleTimer&&this.isConnected()&&this.isIdle()&&(this._idleTimer=setTimeout(this.checkIdle.bind(this),this.idleTimeout()))},e.prototype.clearIdle=function(){0!==this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=0)},e.prototype.checkIdle=function(){this.isConnected()&&this.isIdle()&&this.close()},e.prototype.close=function(){this._context.closeHost(this)},e.prototype.closeUp=function(){this._downlinks.forEach((function(t,e){e.forEach((function(t,e){e.closeUp(this)}),this)}),this)},e}(A),M=function(t){function e(e,o,i){return void 0===i&&(i={}),t.call(this,e,o,i)||this}return p(e,t),Object.defineProperty(e.prototype,"WebSocket",{get:function(){return this._options.WebSocket||"undefined"!=typeof WebSocket&&WebSocket||"function"==typeof require&&require("ws")||void 0},enumerable:!1,configurable:!0}),e.prototype.isConnected=function(){return void 0!==this._socket&&this._socket.readyState===this._socket.OPEN},e.prototype.open=function(){if(this.clearReconnect(),void 0===this._socket){var t=this.WebSocket;if(void 0===t)throw new Error("WebSocket undefined");var e=this._hostUri,o=e.schemeName();"warp"===o||"swim"===o?e=e.scheme("ws"):"warps"!==o&&"swims"!==o||(e=e.scheme("wss")),void 0!==this._options.protocols?this._socket=new t(e.toString(),this._options.protocols):this._socket=new t(e.toString()),this._socket.onopen=this.onWebSocketOpen.bind(this),this._socket.onmessage=this.onWebSocketMessage.bind(this),this._socket.onclose=this.onWebSocketClose.bind(this),this._socket.onerror=this.onWebSocketError.bind(this)}},e.prototype.close=function(){this.clearReconnect(),this.clearIdle(),void 0!==this._socket?(this._socket.close(),this._context.isOnline()||this.onWebSocketClose()):t.prototype.close.call(this)},e.prototype.push=function(t){if(this.isConnected()){this.clearIdle();var e=t.toRecon();this._socket.send(e),this.watchIdle()}else if(t instanceof m){if(!(this._sendBuffer.length<this.sendBufferSize()))throw new Error("send buffer overflow");this._sendBuffer.push(t),this.open()}},e.prototype.onWebSocketOpen=function(){if(this.isConnected()){var t=this.credentials();if(t.isDefined()){var e=new R(t);this.push(e)}this.onConnect();for(var o=void 0;(o=this._sendBuffer.shift())&&this.isConnected();)this.push(o);this.watchIdle()}else this.close()},e.prototype.onWebSocketMessage=function(t){var e=t.data;if("string"==typeof e){var o=l.parseRecon(e);void 0!==o?this.onEnvelope(o):this.onUnknownEnvelope(e)}},e.prototype.onWebSocketClose=function(){void 0!==this._socket&&(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=void 0),this.onDisconnect(),this.clearIdle(),this.isIdle()?this.close():this._context.isOnline()&&this.reconnect()},e.prototype.onWebSocketError=function(){void 0!==this._socket&&(this._socket.close(),this._context.isOnline()?this.onError():this.onWebSocketClose())},e}(S),x=function(){function t(t,e,o,i,n,s,h){void 0===n&&(n=0),void 0===s&&(s=0),void 0===h&&(h=r.Value.absent()),this._context=t,this._hostUri=e,this._nodeUri=o,this._laneUri=i,this._prio=n,this._rate=s,this._body=h,this._views=[],this._host=null,this._status=0}return t.prototype.hostUri=function(){return this._hostUri},t.prototype.nodeUri=function(){return this._nodeUri},t.prototype.laneUri=function(){return this._laneUri},t.prototype.prio=function(){return this._prio},t.prototype.rate=function(){return this._rate},t.prototype.body=function(){return this._body},t.prototype.keepLinked=function(){for(var t=0;t<this._views.length;t+=1)if(this._views[t].keepLinked())return!0;return!1},t.prototype.keepSynced=function(){for(var t=0;t<this._views.length;t+=1)if(this._views[t].keepSynced())return!0;return!1},t.prototype.unlinkDelay=function(){return null!==this._host?this._host.unlinkDelay():0},t.prototype.isConnected=function(){return null!==this._host&&this._host.isConnected()},t.prototype.isAuthenticated=function(){return null!==this._host&&this._host.isAuthenticated()},t.prototype.isLinked=function(){return 0!=(2&this._status)},t.prototype.isSynced=function(){return 0!=(8&this._status)},t.prototype.session=function(){return null!==this._host?this._host.session():r.Value.absent()},t.prototype.addDownlink=function(t){this._views.push(t)},t.prototype.removeDownlink=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e]===t&&(this._views.splice(e,1),t.closeUp());if(0===this._views.length){var o=this.unlinkDelay();o<0?this.unlink():setTimeout(this.doUnlink.bind(this),o)}},t.prototype.onEventMessage=function(t,e){for(var o=0;o<this._views.length;o+=1)this._views[o].onEventMessage(t)},t.prototype.onCommandMessage=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].onCommandMessage(t)},t.prototype.onLinkRequest=function(t){this._status|=1;for(var e=0;e<this._views.length;e+=1)this._views[e].onLinkRequest(t)},t.prototype.onLinkedResponse=function(t,e){this._status=-2&this._status|2;for(var o=0;o<this._views.length;o+=1)this._views[o].onLinkedResponse(t)},t.prototype.onSyncRequest=function(t){this._status|=4;for(var e=0;e<this._views.length;e+=1)this._views[e].onSyncRequest(t)},t.prototype.onSyncedResponse=function(t,e){this._status=-5&this._status|8;for(var o=0;o<this._views.length;o+=1)this._views[o].onSyncedResponse(t)},t.prototype.onUnlinkRequest=function(t,e){this._status=-6&this._status|16;for(var o=0;o<this._views.length;o+=1)this._views[o].onUnlinkRequest(t)},t.prototype.onUnlinkedResponse=function(t,e){if(this._status&=-17,0===this._views.length||0!==this._status){for(var o=0;o<this._views.length;o+=1)this._views[o].onUnlinkedResponse(t);this.close()}else this.keepSynced()?this.sync():this.link()},t.prototype.hostDidConnect=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].hostDidConnect();this.keepSynced()?this.sync():this.link()},t.prototype.hostDidDisconnect=function(t){this._status=0;for(var e=!1,o=0;o<this._views.length;o+=1){var i=this._views[o];i.hostDidDisconnect(),e=e||i.keepLinked()}e||this.close()},t.prototype.hostDidFail=function(t,e){for(var o=0;o<this._views.length;o+=1)this._views[o].hostDidFail(t)},t.prototype.command=function(t){t=r.Value.fromAny(t),this.onCommandMessage(t),this._host.command(this._nodeUri,this._laneUri,t)},t.prototype.sync=function(){var t=this._host.unresolve(this._nodeUri),e=g.of(t,this._laneUri,this._prio,this._rate,this._body);this.onSyncRequest(e),this._host.push(e)},t.prototype.link=function(){var t=this._host.unresolve(this._nodeUri),e=w.of(t,this._laneUri,this._prio,this._rate,this._body);this.onLinkRequest(e),this._host.push(e)},t.prototype.unlink=function(){this._status=16,this._context.unlinkDownlink(this)},t.prototype.doUnlink=function(){0===this._views.length&&this.unlink()},t.prototype.close=function(){this._context.closeDownlink(this)},t.prototype.openUp=function(t){this._host=t;for(var e=0;e<this._views.length;e+=1)this._views[e].openUp(t)},t.prototype.closeUp=function(){var t=this._views;this._views=[];for(var e=0;e<t.length;e+=1)t[e].closeUp()},t}();(C=t.DownlinkFlags||(t.DownlinkFlags={}))[C.KeepLinked=1]="KeepLinked",C[C.KeepSynced=2]="KeepSynced",C[C.KeepLinkedSynced=3]="KeepLinkedSynced";var T=function(){function t(t,e,o,i,s,h,u,l,a,p,d){var c;void 0===i&&(i=n.Uri.empty()),void 0===s&&(s=n.Uri.empty()),void 0===h&&(h=n.Uri.empty()),void 0===u&&(u=0),void 0===l&&(l=0),void 0===a&&(a=r.Value.absent()),void 0===p&&(p=0),void 0===d&&(d=null),null===d?d=[]:Array.isArray(d)||(d=[c=d]),void 0!==o&&(c=c||{},d=null!==d?d.concat(c):[c],i=void 0!==o.hostUri?n.Uri.fromAny(o.hostUri):i,s=void 0!==o.nodeUri?n.Uri.fromAny(o.nodeUri):s,h=void 0!==o.laneUri?n.Uri.fromAny(o.laneUri):h,u=void 0!==o.prio?o.prio:u,l=void 0!==o.rate?o.rate:l,a=void 0!==o.body?r.Value.fromAny(o.body):a,c.onEvent=o.onEvent||c.onEvent,c.onCommand=o.onCommand||c.onCommand,c.willLink=o.willLink||c.willLink,c.didLink=o.didLink||c.didLink,c.willSync=o.willSync||c.willSync,c.didSync=o.didSync||c.didSync,c.willUnlink=o.willUnlink||c.willUnlink,c.didUnlink=o.didUnlink||c.didUnlink,c.didConnect=o.didConnect||c.didConnect,c.didDisconnect=o.didDisconnect||c.didDisconnect,c.didClose=o.didClose||c.didClose,c.didFail=o.didFail||c.didFail),this._context=t,this._owner=e,this._hostUri=i,this._nodeUri=s,this._laneUri=h,this._prio=u,this._rate=l,this._body=a,this._flags=p,this._model=null,this._observers=d}return t.prototype.hostUri=function(t){return void 0===t?this._hostUri:(t=n.Uri.fromAny(t),this.copy(this._context,this._owner,t,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers))},t.prototype.nodeUri=function(t){return void 0===t?this._nodeUri:(t=n.Uri.fromAny(t),this.copy(this._context,this._owner,this._hostUri,t,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers))},t.prototype.laneUri=function(t){return void 0===t?this._laneUri:(t=n.Uri.fromAny(t),this.copy(this._context,this._owner,this._hostUri,this._nodeUri,t,this._prio,this._rate,this._body,this._flags,this._observers))},t.prototype.prio=function(t){return void 0===t?this._prio:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,t,this._rate,this._body,this._flags,this._observers)},t.prototype.rate=function(t){return void 0===t?this._rate:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,t,this._body,this._flags,this._observers)},t.prototype.body=function(t){return void 0===t?this._body:(t=r.Value.fromAny(t),this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,t,this._flags,this._observers))},t.prototype.keepLinked=function(t){if(void 0===t)return 0!=(1&this._flags);var e=t?1|this._flags:-2&this._flags;return this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,e,this._observers)},t.prototype.keepSynced=function(t){if(void 0===t)return 0!=(2&this._flags);var e=t?2|this._flags:-3&this._flags;return this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,e,this._observers)},t.prototype.observe=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=new Array(o+1),n=0;n<o;n+=1)i[n]=e[n];return i[o]=t,this._observers=i,this},t.prototype.unobserve=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i],r=n===t;if(!r)for(var s in n)if(n[s]===t){r=!0;break}if(r){if(o>1){for(var h=new Array(o-1),u=0;u<i;u+=1)h[u]=e[u];for(u=i+1;u<o;u+=1)h[u-1]=e[u];this._observers=h}else this._observers=null;break}}return this},t.prototype.onEvent=function(t){return this.observe({onEvent:t})},t.prototype.onCommand=function(t){return this.observe({onCommand:t})},t.prototype.willLink=function(t){return this.observe({willLink:t})},t.prototype.didLink=function(t){return this.observe({didLink:t})},t.prototype.willSync=function(t){return this.observe({willSync:t})},t.prototype.didSync=function(t){return this.observe({didSync:t})},t.prototype.willUnlink=function(t){return this.observe({willUnlink:t})},t.prototype.didUnlink=function(t){return this.observe({didUnlink:t})},t.prototype.didConnect=function(t){return this.observe({didConnect:t})},t.prototype.didDisconnect=function(t){return this.observe({didDisconnect:t})},t.prototype.didClose=function(t){return this.observe({didClose:t})},t.prototype.didFail=function(t){return this.observe({didFail:t})},t.prototype.isConnected=function(){return null!==this._model&&this._model.isConnected()},t.prototype.isAuthenticated=function(){return null!==this._model&&this._model.isAuthenticated()},t.prototype.isLinked=function(){return null!==this._model&&this._model.isLinked()},t.prototype.isSynced=function(){return null!==this._model&&this._model.isSynced()},t.prototype.session=function(){return null!==this._model?this._model.session():r.Value.absent()},t.prototype.onEventMessage=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.onEvent&&n.onEvent(t.body(),this)}},t.prototype.onCommandMessage=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.onCommand&&n.onCommand(t,this)}},t.prototype.onLinkRequest=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willLink&&n.willLink(this)}},t.prototype.onLinkedResponse=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didLink&&n.didLink(this)}},t.prototype.onSyncRequest=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willSync&&n.willSync(this)}},t.prototype.onSyncedResponse=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didSync&&n.didSync(this)}},t.prototype.onUnlinkRequest=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willUnlink&&n.willUnlink(this)}},t.prototype.onUnlinkedResponse=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didUnlink&&n.didUnlink(this)}},t.prototype.hostDidConnect=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.didConnect&&i.didConnect(this)}},t.prototype.hostDidDisconnect=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.didDisconnect&&i.didDisconnect(this)}},t.prototype.hostDidFail=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didFail&&n.didFail(t,this)}},t.prototype.command=function(t){this._model.command(t)},t.prototype.close=function(){void 0!==this._owner&&this._owner.removeDownlink(this),null!==this._model&&this._model.removeDownlink(this)},t.prototype.openUp=function(t){},t.prototype.closeUp=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.didClose&&i.didClose(this)}},t.initForm=function(){return void 0===t._initForm&&(t._initForm=new O),t._initForm},t}(),O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return p(e,t),e.prototype.tag=function(e){return 0===arguments.length?"link":void 0!==e?t.prototype.tag.call(this,e):this},e.prototype.mold=function(t){if(void 0!==t){var e=r.Record.create();return void 0!==t.hostUri&&e.slot("host",n.Uri.fromAny(t.hostUri).toString()),void 0!==t.nodeUri&&e.slot("node",n.Uri.fromAny(t.nodeUri).toString()),void 0!==t.laneUri&&e.slot("lane",n.Uri.fromAny(t.laneUri).toString()),void 0!==t.prio&&e.slot("prio",t.prio),void 0!==t.rate&&e.slot("rate",t.rate),void 0!==t.body&&e.slot("body",t.body),void 0!==t.type&&e.slot("type",t.type),r.Record.of(r.Attr.of("link",e))}return r.Item.extant()},e.prototype.cast=function(t){var e=t.toValue().get("link");if(e.isDefined()){var o={},i=e.get("host");i.isDefined()&&(o.hostUri=i.cast(n.Uri.form()));var r=e.get("node");r.isDefined()&&(o.nodeUri=r.cast(n.Uri.form()));var s=e.get("lane");s.isDefined()&&(o.laneUri=s.cast(n.Uri.form()));var h=e.get("prio");h.isDefined()&&(o.prio=h.numberValue());var u=e.get("rate");u.isDefined()&&(o.rate=u.numberValue());var l=e.get("body");l.isDefined()&&(o.body=l);var a=e.get("type");return a.isDefined()&&(o.type=a.stringValue()),o}},e}(r.Form),I=function(t){function e(e,o,i,n,r,s,h){return t.call(this,e,o,i,n,r,s,h)||this}return p(e,t),e.prototype.type=function(){return"event"},e}(x),W=function(t){function e(e,o,i,n,r,s,h,u,l,a,p){return void 0===a&&(a=1),t.call(this,e,o,i,n,r,s,h,u,l,a,p)||this}return p(e,t),e.prototype.copy=function(t,o,i,n,r,s,h,u,l,a){return new e(t,o,void 0,i,n,r,s,h,u,l,a)},e.prototype.type=function(){return"event"},e.prototype.observe=function(e){return t.prototype.observe.call(this,e)},e.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var o=this._hostUri;o.isEmpty()&&(o=e.endpoint(),e=o.unresolve(e));var i=this._context.getDownlink(o,e,t);if(void 0!==i){if(!(i instanceof I))throw new Error("downlink type mismatch");i.addDownlink(this)}else(i=new I(this._context,o,e,t,this._prio,this._rate,this._body)).addDownlink(this),this._context.openDownlink(i);return this._model=i,void 0!==this._owner&&this._owner.addDownlink(this),this},e}(T),q=function(t){function e(e,o,i,n,r,h,u,l){void 0===l&&(l=new s.STree);var a=t.call(this,e,o,i,n,r,h,u)||this;return a._state=l,a}return p(e,t),e.prototype.type=function(){return"list"},e.prototype.isEmpty=function(){return this._state.isEmpty()},Object.defineProperty(e.prototype,"length",{get:function(){return this._state.length},enumerable:!1,configurable:!0}),e.prototype.get=function(t,e){return this._state.get(t,e)||r.Value.absent()},e.prototype.getEntry=function(t,e){return this._state.getEntry(t,e)},e.prototype.set=function(t,e,o){if(void 0!==o&&(t=this._state.lookup(o,t))<0)throw new RangeError(""+o);if(t<0||t>=this._state.length)throw new RangeError(""+t);e=this.listWillUpdate(t,e);var i=this._state.getEntry(t);this._state.set(t,e),this.listDidUpdate(t,e,i[1]);var n=r.Record.create(2).slot("key",i[0]).slot("index",t);return this.command(r.Attr.of("update",n).concat(e)),this},e.prototype.insert=function(t,e,o){if(t<0||t>this._state.length)throw new RangeError(""+t);e=this.listWillUpdate(t,e),this._state.insert(t,e,o);var i=this._state.getEntry(t);this.listDidUpdate(t,e,r.Value.absent());var n=r.Record.create(2).slot("key",i[0]).slot("index",t);return this.command(r.Attr.of("update",n).concat(e)),this},e.prototype.remove=function(t,e){if(void 0!==e&&(t=this._state.lookup(e,t))<0)throw new RangeError(""+e);if(t<0||t>this._state.length)throw new RangeError(""+t);this.listWillRemove(t);var o=this._state.getEntry(t);this._state.remove(t),this.listDidRemove(t,o[1]);var i=r.Record.create(2).slot("key",o[0]).slot("index",t);return this.command(r.Record.create(1).attr("remove",i)),this},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=0;o<t.length;o+=1){var i=this._state.length+o,n=this.listWillUpdate(i,t[o]);this._state.insert(i,n);var s=this._state.getEntry(i);this.listDidUpdate(i,n,r.Value.absent());var h=r.Record.create(2).slot("key",s[0]).slot("index",i);this.command(r.Attr.of("update",h).concat(n))}return this._state.length},e.prototype.pop=function(){var t=this._state.length-1;if(t>=0){this.listWillRemove(t);var e=this._state.getEntry(t);this._state.remove(t),this.listDidRemove(t,e[1]);var o=r.Record.create(2).slot("key",e[0]).slot("index",t);return this.command(r.Record.create(1).attr("remove",o)),e[1]}return r.Value.absent()},e.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=t.length-1;o>=0;o-=1){var i=this.listWillUpdate(0,t[o]);this._state.insert(0,i);var n=this._state.getEntry(0);this.listDidUpdate(0,i,r.Value.absent());var s=r.Record.create(2).slot("key",n[0]).slot("index",0);this.command(r.Attr.of("update",s).concat(i))}return this._state.length},e.prototype.shift=function(){if(this._state.length>0){this.listWillRemove(0);var t=this._state.getEntry(0);this._state.remove(0),this.listDidRemove(0,t[1]);var e=r.Record.create(2).slot("key",t[0]).slot("index",0);return this.command(r.Record.create(1).attr("remove",e)),t[1]}return r.Value.absent()},e.prototype.move=function(t,e,o){if(void 0!==o&&(t=this._state.lookup(o,t))<0)throw new RangeError(""+o);if(t<0||t>=this._state.length)throw new RangeError(""+t);if(e<0||e>=this._state.length)throw new RangeError(""+e);if(t!==e){var i=this._state.getEntry(t);this.listWillMove(t,e,i[1]),this._state.remove(t).insert(e,i[1],i[0]),this.listDidMove(t,e,i[1]);var n=r.Record.create(2).slot("key",i[0]).slot("from",t).slot("to",e);this.command(r.Record.create(1).attr("move",n))}return this},e.prototype.splice=function(t,e){for(var o=[],i=2;i<arguments.length;i++)o[i-2]=arguments[i];t<0&&(t=this._state.length+t),t=Math.min(Math.max(0,t),this._state.length),void 0===e&&(e=this._state.length-t);for(var n=[],s=t,h=t+e;s<h;s+=1){this.listWillRemove(t);var u=this._state.getEntry(t);n.push(u[1]),this._state.remove(t),this.listDidRemove(t,u[1]);var l=r.Record.create(2).slot("key",u[0]).slot("index",t);this.command(r.Record.create(1).attr("remove",l))}for(s=0;s<o.length;s+=1){var a=t+s,p=this.listWillUpdate(a,o[s]);this._state.insert(a,p);var d=this._state.getEntry(a);this.listDidUpdate(a,p,r.Value.absent());l=r.Record.create(2).slot("key",d[0]).slot("index",a);this.command(r.Attr.of("update",l).concat(p))}return n},e.prototype.clear=function(){this.listWillClear(),this._state.clear(),this.listDidClear(),this.command(r.Record.create(1).attr("clear"))},e.prototype.forEach=function(t,e){return this._state.forEach((function(o,i,n,r){return t.call(e,o,i,this,r)}),this)},e.prototype.values=function(){return this._state.values()},e.prototype.keys=function(){return this._state.keys()},e.prototype.entries=function(){return this._state.entries()},e.prototype.snapshot=function(){return this._state.clone()},e.prototype.setState=function(t){this._state=t},e.prototype.onEventMessage=function(e,o){t.prototype.onEventMessage.call(this,e,o);var i=e.body(),n=i.tag();if("update"===n){var r=i.head().toValue();(s=this._state.lookup(r.get("key"),r.get("index").numberValue()))>=0?this.onUpdateEvent(s,i.body(),r.get("key")):this.onInsertEvent(r.get("index").numberValue(0),i.body(),r.get("key"))}else if("move"===n){r=i.head().toValue();(s=this._state.lookup(r.get("key"),r.get("from").numberValue()))>=0&&this.onMoveEvent(s,r.get("to").numberValue(0),r.get("key"))}else if("remove"===n){var s;r=i.head().toValue();(s=this._state.lookup(r.get("key"),r.get("index").numberValue()))>=0&&this.onRemoveEvent(s,r.get("key"))}else if("drop"===n){r=i.head();this.onDropEvent(r.numberValue(0))}else if("take"===n){r=i.head();this.onTakeEvent(r.numberValue(0))}else"clear"===n&&this.onClearEvent()},e.prototype.onInsertEvent=function(t,e,o){e=this.listWillUpdate(t,e),this._state.insert(t,e,o),this.listDidUpdate(t,e,r.Value.absent())},e.prototype.onUpdateEvent=function(t,e,o){e=this.listWillUpdate(t,e);var i=this._state.get(t)||r.Value.absent();this._state.set(t,e),this.listDidUpdate(t,e,i)},e.prototype.onMoveEvent=function(t,e,o){if(t!==(e=Math.min(Math.max(0,e),this._state.length))){var i=this._state.get(t)||r.Value.absent();this.listWillMove(t,e,i),this._state.remove(t).insert(e,i,o),this.listDidMove(t,e,i)}},e.prototype.onRemoveEvent=function(t,e){this.listWillRemove(t);var o=this._state.get(t)||r.Value.absent();this._state.remove(t),this.listDidRemove(t,o)},e.prototype.onDropEvent=function(t){this.listWillDrop(t),this._state.drop(t),this.listDidDrop(t)},e.prototype.onTakeEvent=function(t){this.listWillTake(t),this._state.take(t),this.listDidTake(t)},e.prototype.onClearEvent=function(){this.listWillClear(),this._state.clear(),this.listDidClear()},e.prototype.listWillUpdate=function(t,e){for(var o=0;o<this._views.length;o+=1)e=this._views[o].listWillUpdate(t,e);return e},e.prototype.listDidUpdate=function(t,e,o){for(var i=0;i<this._views.length;i+=1)this._views[i].listDidUpdate(t,e,o)},e.prototype.listWillMove=function(t,e,o){for(var i=0;i<this._views.length;i+=1)this._views[i].listWillMove(t,e,o)},e.prototype.listDidMove=function(t,e,o){for(var i=0;i<this._views.length;i+=1)this._views[i].listDidMove(t,e,o)},e.prototype.listWillRemove=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillRemove(t)},e.prototype.listDidRemove=function(t,e){for(var o=0;o<this._views.length;o+=1)this._views[o].listDidRemove(t,e)},e.prototype.listWillDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillDrop(t)},e.prototype.listDidDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listDidDrop(t)},e.prototype.listWillTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillTake(t)},e.prototype.listDidTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listDidTake(t)},e.prototype.listWillClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].listWillClear()},e.prototype.listDidClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].listDidClear()},e}(x),L=function(t){function e(e,o,i,n,s,h,u,l,a,p,d,c,f){void 0===p&&(p=3);var v=t.call(this,e,o,i,n,s,h,u,l,a,p,d)||this;if(void 0!==i){var _=v._observers[v._observers.length-1];_.willUpdate=i.willUpdate||_.willUpdate,_.didUpdate=i.didUpdate||_.didUpdate,_.willMove=i.willMove||_.willMove,_.didMove=i.didMove||_.didMove,_.willRemove=i.willRemove||_.willRemove,_.didRemove=i.didRemove||_.didRemove,_.willDrop=i.willDrop||_.willDrop,_.didDrop=i.didDrop||_.didDrop,_.willTake=i.willTake||_.willTake,_.didTake=i.didTake||_.didTake,_.willClear=i.willClear||_.willClear,_.didClear=i.didClear||_.didClear,c=void 0!==i.valueForm?i.valueForm:c}return v._valueForm=void 0!==c?c:r.Form.forValue(),v._state0=f,v}return p(e,t),e.prototype.copy=function(t,o,i,n,r,s,h,u,l,a,p,d){return 10===arguments.length&&(p=this._valueForm,d=this._state0),new e(t,o,void 0,i,n,r,s,h,u,l,a,p,d)},e.prototype.type=function(){return"list"},e.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,t,this._state0)},e.prototype.isEmpty=function(){return this._model.isEmpty()},Object.defineProperty(e.prototype,"length",{get:function(){return this._model.length},enumerable:!1,configurable:!0}),e.prototype.get=function(t,e){return this._model.get(t,e).coerce(this._valueForm)},e.prototype.getEntry=function(t,e){var o=this._model.getEntry(t,e);if(void 0!==o)return[o[0].coerce(this._valueForm),o[1]]},e.prototype.set=function(t,e,o){var i=this._valueForm.mold(e);return this._model.set(t,i,o),this},e.prototype.insert=function(t,e,o){var i=this._valueForm.mold(e);return this._model.insert(t,i,o),this},e.prototype.remove=function(t,e){return this._model.remove(t,e),this},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=new Array(t.length),i=0;i<t.length;i+=1)o[i]=this._valueForm.mold(t[i]);return this._model.push.apply(this._model,o)},e.prototype.pop=function(){return this._model.pop().coerce(this._valueForm)},e.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=new Array(t.length),i=0;i<t.length;i+=1)o[i]=this._valueForm.mold(t[i]);return this._model.unshift.apply(this._model,o)},e.prototype.shift=function(){return this._model.shift().coerce(this._valueForm)},e.prototype.move=function(t,e,o){return this._model.move(t,e,o),this},e.prototype.splice=function(t,e){for(var o,i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];for(var r=new Array(i.length),s=0;s<i.length;s+=1)r[s]=this._valueForm.mold(i[s]);var h=(o=this._model).splice.apply(o,c([t,e],r)),u=new Array(h.length);for(s=0;s<h.length;s+=1)u[s]=h[s].coerce(this._valueForm);return u},e.prototype.clear=function(){this._model.clear()},e.prototype.forEach=function(t,e){return this._valueForm===r.Form.forValue()?this._model._state.forEach(t,e):this._model._state.forEach((function(o,i,n,r){var s=o.coerce(this._valueForm);return t.call(e,s,i,this,r)}),this)},e.prototype.values=function(){var t=this._model.values();return this._valueForm===r.Form.forValue()?t:new r.ValueCursor(t,this._valueForm)},e.prototype.keys=function(){return this._model.keys()},e.prototype.entries=function(){var t=this._model.entries();return this._valueForm===r.Form.forValue()?t:new r.ValueEntryCursor(t,r.Form.forValue(),this._valueForm)},e.prototype.snapshot=function(){return this._model.snapshot()},e.prototype.setState=function(t){this._model.setState(t)},e.prototype.observe=function(e){return t.prototype.observe.call(this,e)},e.prototype.willUpdate=function(t){return this.observe({willUpdate:t})},e.prototype.didUpdate=function(t){return this.observe({didUpdate:t})},e.prototype.willMove=function(t){return this.observe({willMove:t})},e.prototype.didMove=function(t){return this.observe({didMove:t})},e.prototype.willRemove=function(t){return this.observe({willRemove:t})},e.prototype.didRemove=function(t){return this.observe({didRemove:t})},e.prototype.willDrop=function(t){return this.observe({willDrop:t})},e.prototype.didDrop=function(t){return this.observe({didDrop:t})},e.prototype.willTake=function(t){return this.observe({willTake:t})},e.prototype.didTake=function(t){return this.observe({didTake:t})},e.prototype.willClear=function(t){return this.observe({willClear:t})},e.prototype.didClear=function(t){return this.observe({didClear:t})},e.prototype.listWillUpdate=function(t,e){for(var o,i=this._observers,n=null!==i?i.length:0,r=0;r<n;r+=1){var s=i[r];if(void 0!==s.willUpdate){void 0===o&&(o=e.coerce(this._valueForm));var h=s.willUpdate(t,o,this);void 0!==h&&(o=h,e=this._valueForm.mold(o))}}return e},e.prototype.listDidUpdate=function(t,e,o){for(var i,n,r=this._observers,s=null!==r?r.length:0,h=0;h<s;h+=1){var u=r[h];void 0!==u.didUpdate&&(void 0===i&&(i=e.coerce(this._valueForm)),void 0===n&&(n=o.coerce(this._valueForm)),u.didUpdate(t,i,n,this))}},e.prototype.listWillMove=function(t,e,o){for(var i,n=this._observers,r=null!==n?n.length:0,s=0;s<r;s+=1){var h=n[s];void 0!==h.willMove&&(void 0===i&&(i=o.coerce(this._valueForm)),h.willMove(t,e,i,this))}},e.prototype.listDidMove=function(t,e,o){for(var i,n=this._observers,r=null!==n?n.length:0,s=0;s<r;s+=1){var h=n[s];void 0!==h.didMove&&(void 0===i&&(i=o.coerce(this._valueForm)),h.didMove(t,e,i,this))}},e.prototype.listWillRemove=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willRemove&&n.willRemove(t,this)}},e.prototype.listDidRemove=function(t,e){for(var o,i=this._observers,n=null!==i?i.length:0,r=0;r<n;r+=1){var s=i[r];void 0!==s.didRemove&&(void 0===o&&(o=e.coerce(this._valueForm)),s.didRemove(t,o,this))}},e.prototype.listWillDrop=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willDrop&&n.willDrop(t,this)}},e.prototype.listDidDrop=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didDrop&&n.didDrop(t,this)}},e.prototype.listWillTake=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willTake&&n.willTake(t,this)}},e.prototype.listDidTake=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didTake&&n.didTake(t,this)}},e.prototype.listWillClear=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.willClear&&i.willClear(this)}},e.prototype.listDidClear=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.didClear&&i.didClear(this)}},e.prototype.initialState=function(t){return void 0===t?this._state0||null:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,this._valueForm,t||void 0)},e.prototype.didAliasModel=function(){this.onLinkedResponse(),this._model._state.forEach((function(t,e){this.listDidUpdate(e,t,r.Value.absent())}),this),this.onSyncedResponse()},e.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var o=this._hostUri;o.isEmpty()&&(o=e.endpoint(),e=o.unresolve(e));var i=this._context.getDownlink(o,e,t);if(void 0!==i){if(!(i instanceof q))throw new Error("downlink type mismatch");i.addDownlink(this),this._model=i,setTimeout(this.didAliasModel.bind(this))}else(i=new q(this._context,o,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(i),this._model=i;return void 0!==this._owner&&this._owner.addDownlink(this),this},e}(T),K=function(t){function e(e,o,i,n,r,h,u,l){void 0===l&&(l=new s.BTree);var a=t.call(this,e,o,i,n,r,h,u)||this;return a._state=l,a}return p(e,t),e.prototype.type=function(){return"map"},Object.defineProperty(e.prototype,"size",{get:function(){return this._state.size},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){return this._state.isEmpty()},e.prototype.has=function(t){return this._state.has(t)},e.prototype.get=function(t){return this._state.get(t)||r.Value.absent()},e.prototype.getEntry=function(t){return this._state.getEntry(t)},e.prototype.set=function(t,e){e=this.mapWillUpdate(t,e);var o=this._state.get(t)||r.Value.absent();this._state.set(t,e),this.mapDidUpdate(t,e,o);var i=r.Record.create(1).slot("key",t);return this.command(r.Attr.of("update",i).concat(e)),this},e.prototype.delete=function(t){if(this._state.has(t)){this.mapWillRemove(t);var e=this._state.get(t)||r.Value.absent();this._state.delete(t),this.mapDidRemove(t,e);var o=r.Record.create(1).slot("key",t);return this.command(r.Record.create(1).attr("remove",o)),!0}return!1},e.prototype.drop=function(t){return this.mapWillDrop(t),this._state.drop(t),this.mapDidDrop(t),this.command(r.Record.create(1).attr("drop",t)),this},e.prototype.take=function(t){return this.mapWillTake(t),this._state.take(t),this.mapDidTake(t),this.command(r.Record.create(1).attr("take",t)),this},e.prototype.clear=function(){this.mapWillClear(),this._state.clear(),this.mapDidClear(),this.command(r.Record.create(1).attr("clear"))},e.prototype.forEach=function(t,e){return this._state.forEach((function(o,i){return t.call(e,o,i,this)}),this)},e.prototype.keys=function(){return this._state.keys()},e.prototype.values=function(){return this._state.values()},e.prototype.entries=function(){return this._state.entries()},e.prototype.snapshot=function(){return this._state.clone()},e.prototype.setState=function(t){this._state=t},e.prototype.onEventMessage=function(e,o){t.prototype.onEventMessage.call(this,e,o);var i=e.body(),n=i.tag();if("update"===n){var r=i.head().toValue();this.onUpdateEvent(r.get("key"),i.body())}else if("remove"===n){r=i.head().toValue();this.onRemoveEvent(r.get("key"))}else if("drop"===n){r=i.head().toValue();this.onDropEvent(r.numberValue(0))}else if("take"===n){r=i.head().toValue();this.onTakeEvent(r.numberValue(0))}else"clear"===n&&this.onClearEvent()},e.prototype.onUpdateEvent=function(t,e){e=this.mapWillUpdate(t,e);var o=this._state.get(t)||r.Value.absent();this._state.set(t,e),this.mapDidUpdate(t,e,o)},e.prototype.onRemoveEvent=function(t){this.mapWillRemove(t);var e=this._state.get(t)||r.Value.absent();this._state.delete(t),this.mapDidRemove(t,e)},e.prototype.onDropEvent=function(t){this.mapWillDrop(t),this._state.drop(t),this.mapDidDrop(t)},e.prototype.onTakeEvent=function(t){this.mapWillTake(t),this._state.take(t),this.mapDidTake(t)},e.prototype.onClearEvent=function(){this.mapWillClear(),this._state.clear(),this.mapDidClear()},e.prototype.mapWillUpdate=function(t,e){for(var o=0;o<this._views.length;o+=1)e=this._views[o].mapWillUpdate(t,e);return e},e.prototype.mapDidUpdate=function(t,e,o){for(var i=0;i<this._views.length;i+=1)this._views[i].mapDidUpdate(t,e,o)},e.prototype.mapWillRemove=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillRemove(t)},e.prototype.mapDidRemove=function(t,e){for(var o=0;o<this._views.length;o+=1)this._views[o].mapDidRemove(t,e)},e.prototype.mapWillDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillDrop(t)},e.prototype.mapDidDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapDidDrop(t)},e.prototype.mapWillTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillTake(t)},e.prototype.mapDidTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapDidTake(t)},e.prototype.mapWillClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].mapWillClear()},e.prototype.mapDidClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].mapDidClear()},e}(x),j=function(t){function e(e,o,i,n,h,u,l,a,p,d,c,f,v,_){void 0===d&&(d=3);var y=t.call(this,e,o,i,n,h,u,l,a,p,d,c)||this;if(void 0!==i){var m=y._observers[y._observers.length-1];m.willUpdate=i.willUpdate||m.willUpdate,m.didUpdate=i.didUpdate||m.didUpdate,m.willRemove=i.willRemove||m.willRemove,m.didRemove=i.didRemove||m.didRemove,m.willDrop=i.willDrop||m.willDrop,m.didDrop=i.didDrop||m.didDrop,m.willTake=i.willTake||m.willTake,m.didTake=i.didTake||m.didTake,m.willClear=i.willClear||m.willClear,m.didClear=i.didClear||m.didClear,f=void 0!==i.keyForm?i.keyForm:f,v=void 0!==i.valueForm?i.valueForm:v}return y._keyForm=void 0!==f?f:r.Form.forValue(),y._valueForm=void 0!==v?v:r.Form.forValue(),y._state0=_,y._input=null,y._effects=new s.BTree,y._outlets=new s.BTree,y._outputs=null,y._version=-1,y}return p(e,t),e.prototype.copy=function(t,o,i,n,r,s,h,u,l,a,p,d,c){return 10===arguments.length&&(c=this._state0,p=this._keyForm,d=this._valueForm),new e(t,o,void 0,i,n,r,s,h,u,l,a,p,d,c)},e.prototype.type=function(){return"map"},e.prototype.keyForm=function(t){return void 0===t?this._keyForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,t,this._valueForm,this._state0)},e.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,this._keyForm,t,this._state0)},Object.defineProperty(e.prototype,"size",{get:function(){return this._model.size},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){return this._model.isEmpty()},e.prototype.has=function(t){var e=this._keyForm.mold(t);return this._model.has(e)},e.prototype.get=function(t){if(void 0===t)return this;var e=this._keyForm.mold(t);return this._model.get(e).coerce(this._valueForm)},e.prototype.getEntry=function(t){var e=this._model.getEntry(t);if(void 0!==e)return[e[0].coerce(this._keyForm),e[1].coerce(this._valueForm)]},e.prototype.firstKey=function(){var t=this._model._state.firstKey();if(void 0!==t){var e=this._keyForm.cast(t);if(void 0!==e)return e}return this._keyForm.unit()},e.prototype.firstValue=function(){var t=this._model._state.firstValue();if(void 0!==t){var e=this._valueForm.cast(t);if(void 0!==e)return e}return this._valueForm.unit()},e.prototype.firstEntry=function(){var t=this._model._state.firstEntry();if(void 0!==t)return[this._keyForm.cast(t[0]),this._valueForm.cast(t[1])]},e.prototype.lastKey=function(){var t=this._model._state.lastKey();if(void 0!==t){var e=this._keyForm.cast(t);if(void 0!==e)return e}return this._keyForm.unit()},e.prototype.lastValue=function(){var t=this._model._state.lastValue();if(void 0!==t){var e=this._valueForm.cast(t);if(void 0!==e)return e}return this._valueForm.unit()},e.prototype.lastEntry=function(){var t=this._model._state.lastEntry();if(void 0!==t)return[this._keyForm.cast(t[0]),this._valueForm.cast(t[1])]},e.prototype.nextKey=function(t){var e=this._keyForm.mold(t),o=this._model._state.nextKey(e);if(void 0!==o){var i=this._keyForm.cast(o);if(void 0!==i)return i}return this._keyForm.unit()},e.prototype.nextValue=function(t){var e=this._keyForm.mold(t),o=this._model._state.nextValue(e);if(void 0!==o){var i=this._valueForm.cast(o);if(void 0!==i)return i}return this._valueForm.unit()},e.prototype.nextEntry=function(t){var e=this._keyForm.mold(t),o=this._model._state.nextEntry(e);if(void 0!==o)return[this._keyForm.cast(o[0]),this._valueForm.cast(o[1])]},e.prototype.previousKey=function(t){var e=this._keyForm.mold(t),o=this._model._state.previousKey(e);if(void 0!==o){var i=this._keyForm.cast(o);if(void 0!==i)return i}return this._keyForm.unit()},e.prototype.previousValue=function(t){var e=this._keyForm.mold(t),o=this._model._state.previousValue(e);if(void 0!==o){var i=this._valueForm.cast(o);if(void 0!==i)return i}return this._valueForm.unit()},e.prototype.previousEntry=function(t){var e=this._keyForm.mold(t),o=this._model._state.previousEntry(e);if(void 0!==o)return[this._keyForm.cast(o[0]),this._valueForm.cast(o[1])]},e.prototype.set=function(t,e){var o=this._keyForm.mold(t),i=this._valueForm.mold(e);return this._model.set(o,i),this},e.prototype.delete=function(t){var e=this._keyForm.mold(t);return this._model.delete(e)},e.prototype.drop=function(t){return this._model.drop(t),this},e.prototype.take=function(t){return this._model.take(t),this},e.prototype.clear=function(){this._model.clear()},e.prototype.forEach=function(t,e){return this._keyForm===r.Form.forValue()&&this._valueForm===r.Form.forValue()?this._model._state.forEach(t,e):this._model._state.forEach((function(o,i){var n=o.coerce(this._keyForm),r=i.coerce(this._valueForm);return t.call(e,n,r,this)}),this)},e.prototype.keys=function(){var t=this._model.keys();return this._keyForm===r.Form.forValue()?t:new r.ValueCursor(t,this._keyForm)},e.prototype.values=function(){var t=this._model.values();return this._valueForm===r.Form.forValue()?t:new r.ValueCursor(t,this._valueForm)},e.prototype.entries=function(){var t=this._model.entries();return this._keyForm===r.Form.forValue()&&this._valueForm===r.Form.forValue()?t:new r.ValueEntryCursor(t,this._keyForm,this._valueForm)},e.prototype.snapshot=function(){return this._model.snapshot()},e.prototype.setState=function(t){this._model.setState(t)},e.prototype.observe=function(e){return t.prototype.observe.call(this,e)},e.prototype.willUpdate=function(t){return this.observe({willUpdate:t})},e.prototype.didUpdate=function(t){return this.observe({didUpdate:t})},e.prototype.willRemove=function(t){return this.observe({willRemove:t})},e.prototype.didRemove=function(t){return this.observe({didRemove:t})},e.prototype.willDrop=function(t){return this.observe({willDrop:t})},e.prototype.didDrop=function(t){return this.observe({didDrop:t})},e.prototype.willTake=function(t){return this.observe({willTake:t})},e.prototype.didTake=function(t){return this.observe({didTake:t})},e.prototype.willClear=function(t){return this.observe({willClear:t})},e.prototype.didClear=function(t){return this.observe({didClear:t})},e.prototype.mapWillUpdate=function(t,e){for(var o,i,n=this._observers,r=null!==n?n.length:0,s=0;s<r;s+=1){var h=n[s];if(void 0!==h.willUpdate){void 0===o&&(o=t.coerce(this._keyForm)),void 0===i&&(i=e.coerce(this._valueForm));var u=h.willUpdate(o,i,this);void 0!==u&&(i=u,e=this._valueForm.mold(i))}}return e},e.prototype.mapDidUpdate=function(t,e,o){for(var i,n,r=this._observers,s=null!==r?r.length:0,h=t.coerce(this._keyForm),u=0;u<s;u+=1){var l=r[u];void 0!==l.didUpdate&&(void 0===i&&(i=e.coerce(this._valueForm)),void 0===n&&(n=o.coerce(this._valueForm)),l.didUpdate(h,i,n,this))}this.decohereInputKey(h,0),this.recohereInput(0)},e.prototype.mapWillRemove=function(t){for(var e,o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.willRemove&&(void 0===e&&(e=t.coerce(this._keyForm)),r.willRemove(e,this))}},e.prototype.mapDidRemove=function(t,e){for(var o,i=this._observers,n=null!==i?i.length:0,r=t.coerce(this._keyForm),s=0;s<n;s+=1){var h=i[s];void 0!==h.didRemove&&(void 0===o&&(o=e.coerce(this._valueForm)),h.didRemove(r,o,this))}this.decohereInputKey(r,1),this.recohereInput(0)},e.prototype.mapWillDrop=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willDrop&&n.willDrop(t,this)}},e.prototype.mapDidDrop=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didDrop&&n.didDrop(t,this)}},e.prototype.mapWillTake=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.willTake&&n.willTake(t,this)}},e.prototype.mapDidTake=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didTake&&n.didTake(t,this)}},e.prototype.mapWillClear=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.willClear&&i.willClear(this)}},e.prototype.mapDidClear=function(){for(var t=this._observers,e=null!==t?t.length:0,o=0;o<e;o+=1){var i=t[o];void 0!==i.didClear&&i.didClear(this)}},e.prototype.initialState=function(t){return void 0===t?this._state0||null:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,this._keyForm,this._valueForm,t||void 0)},e.prototype.didAliasModel=function(){this.onLinkedResponse(),this._model._state.forEach((function(t,e){this.mapDidUpdate(t,e,r.Value.absent())}),this),this.onSyncedResponse()},e.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var o=this._hostUri;o.isEmpty()&&(o=e.endpoint(),e=o.unresolve(e));var i=this._context.getDownlink(o,e,t);if(void 0!==i){if(!(i instanceof K))throw new Error("downlink type mismatch");i.addDownlink(this),this._model=i,setTimeout(this.didAliasModel.bind(this))}else(i=new K(this._context,o,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(i),this._model=i;return void 0!==this._owner&&this._owner.addDownlink(this),this},e.prototype.keyIterator=function(){return this.keys()},e.prototype.input=function(){return this._input},e.prototype.bindInput=function(t){if(!h.MapOutlet.is(t))throw new TypeError(""+t);null!==this._input&&this._input.unbindOutput(this),this._input=t,null!==this._input&&this._input.bindOutput(this)},e.prototype.unbindInput=function(){null!==this._input&&this._input.unbindOutput(this),this._input=null},e.prototype.disconnectInputs=function(){var t=this._input;null!==t&&(t.unbindOutput(this),this._input=null,t.disconnectInputs())},e.prototype.outlet=function(t){var e=this._outlets.get(t);return void 0===e&&(e=new h.KeyOutlet(this,t),this._outlets=this._outlets.updated(t,e)),e},e.prototype.outputIterator=function(){return null!==this._outputs?i.Cursor.array(this._outputs):i.Cursor.empty()},e.prototype.bindOutput=function(t){for(var e=this._outputs,o=null!==e?e.length:0,i=new Array(o+1),n=0;n<o;n+=1)i[n]=e[n];i[o]=t,this._outputs=i},e.prototype.unbindOutput=function(t){for(var e=this._outputs,o=null!==e?e.length:0,i=0;i<o;i+=1)if(e[i]===t){if(o>1){for(var n=new Array(o-1),r=0;r<i;r+=1)n[r]=e[r];for(r=i;r<o-1;r+=1)n[r]=e[r+1];this._outputs=n}else this._outputs=null;break}},e.prototype.unbindOutputs=function(){var t=this._outputs;if(null!==t){this._outputs=null;for(var e=0,o=t.length;e<o;e+=1)t[e].unbindInput()}},e.prototype.disconnectOutputs=function(){var t=this._outlets;t.isEmpty()&&(this._outlets=new s.BTree,t.forEach((function(t,e){e.disconnectOutputs()}),this));var e=this._outputs;if(null!==e){this._outputs=null;for(var o=0,i=e.length;o<i;o+=1){var n=e[o];n.unbindInput(),n.disconnectOutputs()}}},e.prototype.decohereOutputKey=function(t,e){this.decohereKey(t,e)},e.prototype.decohereInputKey=function(t,e){this.decohereKey(t,e)},e.prototype.decohereKey=function(t,e){var o=this._effects;if(o.get(t)!==e){this.willDecohereKey(t,e),this._effects=o.updated(t,e),this._version=-1,this.onDecohereKey(t,e);for(var i=null!==this._outputs?this._outputs.length:0,n=0;n<i;n+=1){var r=this._outputs[n];h.MapInlet.is(r)?r.decohereOutputKey(t,e):r.decohereOutput()}var s=this._outlets.get(t);void 0!==s&&s.decohereInput(),this.didDecohereKey(t,e)}},e.prototype.decohereOutput=function(){this.decohere()},e.prototype.decohereInput=function(){this.decohere()},e.prototype.decohere=function(){if(this._version>=0){this.willDecohere(),this._version=-1,this.onDecohere();for(var t=null!==this._outputs?this._outputs.length:0,e=0;e<t;e+=1)this._outputs[e].decohereOutput();this._outlets.forEach((function(t,e){e.decohereInput()}),this),this.didDecohere()}},e.prototype.recohereOutputKey=function(t,e){this.recohereKey(t,e)},e.prototype.recohereInputKey=function(t,e){this.recohereKey(t,e)},e.prototype.recohereKey=function(t,e){if(this._version<0){var o=this._effects,i=o.get(t);if(void 0!==i){this.willRecohereKey(t,i,e),this._effects=o.removed(t),null!==this._input&&this._input.recohereInputKey(t,e),this.onRecohereKey(t,i,e);for(var n=0,r=null!==this._outputs?this._outputs.length:0;n<r;n+=1){var s=this._outputs[n];h.MapInlet.is(s)&&s.recohereOutputKey(t,e)}var u=this._outlets.get(t);void 0!==u&&u.recohereInput(e),this.didRecohereKey(t,i,e)}}},e.prototype.recohereOutput=function(t){this.recohere(t)},e.prototype.recohereInput=function(t){this.recohere(t)},e.prototype.recohere=function(t){if(this._version<0){this.willRecohere(t),this._effects.forEach((function(e){this.recohereKey(e,t)}),this),this._version=t,this.onRecohere(t);for(var e=0,o=null!==this._outputs?this._outputs.length:0;e<o;e+=1)this._outputs[e].recohereOutput(t);this.didRecohere(t)}},e.prototype.willDecohereKey=function(t,e){},e.prototype.onDecohereKey=function(t,e){},e.prototype.didDecohereKey=function(t,e){},e.prototype.willDecohere=function(){},e.prototype.onDecohere=function(){},e.prototype.didDecohere=function(){},e.prototype.willRecohereKey=function(t,e,o){},e.prototype.onRecohereKey=function(t,e,o){if(0===e){if(null!==this._input){var i=this._input.get(t);void 0!==i?this.set(t,i):this.delete(t)}}else 1===e&&this.delete(t)},e.prototype.didRecohereKey=function(t,e,o){},e.prototype.willRecohere=function(t){},e.prototype.onRecohere=function(t){},e.prototype.didRecohere=function(t){},e.prototype.memoize=function(){return this},e.prototype.filter=function(t){var e=new h.FilterFieldsCombinator(t);return e.bindInput(this),e},e.prototype.map=function(t){var e;return 1===t.length?((e=new h.MapValueCombinator(t)).bindInput(this),e):((e=new h.MapFieldValuesCombinator(t)).bindInput(this),e)},e.prototype.reduce=function(t,e,o){var i=new h.ReduceFieldsCombinator(t,e,o);return i.bindInput(this),i},e.prototype.watch=function(t){return 1===t.length?(new h.WatchValueCombinator(t).bindInput(this),this):(new h.WatchFieldsCombinator(t).bindInput(this),this)},e}(T),B=function(t){function e(e,o,i,n,s,h,u,l){void 0===l&&(l=r.Value.absent());var a=t.call(this,e,o,i,n,s,h,u)||this;return a._state=l,a}return p(e,t),e.prototype.type=function(){return"value"},e.prototype.get=function(){return this._state},e.prototype.set=function(t){t=this.valueWillSet(t);var e=this._state;this.setState(t),this.valueDidSet(t,e),this.command(t)},e.prototype.setState=function(t){this._state=t},e.prototype.onEventMessage=function(e,o){t.prototype.onEventMessage.call(this,e,o),this.onSetEvent(e.body())},e.prototype.onSetEvent=function(t){t=this.valueWillSet(t);var e=this._state;this.setState(t),this.valueDidSet(t,e)},e.prototype.valueWillSet=function(t){for(var e=0;e<this._views.length;e+=1)t=this._views[e].valueWillSet(t);return t},e.prototype.valueDidSet=function(t,e){for(var o=0;o<this._views.length;o+=1)this._views[o].valueDidSet(t,e)},e}(x),P=function(t){function e(e,o,i,n,s,h,u,l,a,p,d,c,f){void 0===p&&(p=3),void 0===f&&(f=r.Value.absent());var v=t.call(this,e,o,i,n,s,h,u,l,a,p,d)||this;if(void 0!==i){var _=v._observers[v._observers.length-1];_.willSet=i.willSet||_.willSet,_.didSet=i.didSet||_.didSet,c=void 0!==i.valueForm?i.valueForm:c}return v._valueForm=void 0!==c?c:r.Form.forValue(),v._state0=f,v._input=null,v._outputs=null,v._version=-1,v}return p(e,t),e.prototype.copy=function(t,o,i,n,r,s,h,u,l,a,p,d){return 10===arguments.length&&(d=this._state0,p=this._valueForm),new e(t,o,void 0,i,n,r,s,h,u,l,a,p,d)},e.prototype.type=function(){return"value"},e.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,t,this._state0)},e.prototype.get=function(){return this._model.get().coerce(this._valueForm)},e.prototype.set=function(t){var e=this._valueForm.mold(t);this._model.set(e)},e.prototype.setState=function(t){this._model.setState(t)},e.prototype.observe=function(e){return t.prototype.observe.call(this,e)},e.prototype.willSet=function(t){return this.observe({willSet:t})},e.prototype.didSet=function(t){return this.observe({didSet:t})},e.prototype.valueWillSet=function(t){for(var e,o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];if(void 0!==r.willSet){void 0===e&&(e=t.coerce(this._valueForm));var s=r.willSet(e,this);void 0!==s&&(e=s,t=this._valueForm.mold(e))}}return t},e.prototype.valueDidSet=function(t,e){for(var o,i,n=this._observers,r=null!==n?n.length:0,s=0;s<r;s+=1){var h=n[s];void 0!==h.didSet&&(void 0===o&&(o=t.coerce(this._valueForm)),void 0===i&&(i=e.coerce(this._valueForm)),h.didSet(o,i,this))}this.decohere(),this.recohere(0)},e.prototype.initialState=function(t){return void 0===t?this._state0:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this._observers,this._valueForm,t)},e.prototype.didAliasModel=function(){this.onLinkedResponse(),this.valueDidSet(this._model.get(),r.Value.absent()),this.onSyncedResponse()},e.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var o=this._hostUri;o.isEmpty()&&(o=e.endpoint(),e=o.unresolve(e));var i=this._context.getDownlink(o,e,t);if(void 0!==i){if(!(i instanceof B))throw new Error("downlink type mismatch");i.addDownlink(this),this._model=i,setTimeout(this.didAliasModel.bind(this))}else(i=new B(this._context,o,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(i),this._model=i;return void 0!==this._owner&&this._owner.addDownlink(this),this},e.prototype.input=function(){return this._input},e.prototype.bindInput=function(t){null!==this._input&&this._input.unbindOutput(this),this._input=t,null!==this._input&&this._input.bindOutput(this)},e.prototype.unbindInput=function(){null!==this._input&&this._input.unbindOutput(this),this._input=null},e.prototype.disconnectInputs=function(){var t=this._input;null!==t&&(t.unbindOutput(this),this._input=null,t.disconnectInputs())},e.prototype.outputIterator=function(){return null!==this._outputs?i.Cursor.array(this._outputs):i.Cursor.empty()},e.prototype.bindOutput=function(t){for(var e=this._outputs,o=null!==e?e.length:0,i=new Array(o+1),n=0;n<o;n+=1)i[n]=e[n];i[o]=t,this._outputs=i},e.prototype.unbindOutput=function(t){for(var e=this._outputs,o=null!==e?e.length:0,i=0;i<o;i+=1)if(e[i]===t){if(o>1){for(var n=new Array(o-1),r=0;r<i;r+=1)n[r]=e[r];for(r=i;r<o-1;r+=1)n[r]=e[r+1];this._outputs=n}else this._outputs=null;break}},e.prototype.unbindOutputs=function(){var t=this._outputs;if(null!==t){this._outputs=null;for(var e=0,o=t.length;e<o;e+=1)t[e].unbindInput()}},e.prototype.disconnectOutputs=function(){var t=this._outputs;if(null!==t){this._outputs=null;for(var e=0,o=t.length;e<o;e+=1){var i=t[e];i.unbindInput(),i.disconnectOutputs()}}},e.prototype.decohereOutput=function(){this.decohere()},e.prototype.decohereInput=function(){this.decohere()},e.prototype.decohere=function(){if(this._version>=0){this.willDecohere(),this._version=-1,this.onDecohere();for(var t=null!==this._outputs?this._outputs.length:0,e=0;e<t;e+=1)this._outputs[e].decohereOutput();this.didDecohere()}},e.prototype.recohereOutput=function(t){this.recohere(t)},e.prototype.recohereInput=function(t){this.recohere(t)},e.prototype.recohere=function(t){if(this._version<0){this.willRecohere(t),this._version=t,null!==this._input&&this._input.recohereInput(t),this.onRecohere(t);for(var e=null!==this._outputs?this._outputs.length:0,o=0;o<e;o+=1)this._outputs[o].recohereOutput(t);this.didRecohere(t)}},e.prototype.willDecohere=function(){},e.prototype.onDecohere=function(){},e.prototype.didDecohere=function(){},e.prototype.willRecohere=function(t){},e.prototype.onRecohere=function(t){if(null!==this._input){var e=this._input.get();void 0!==e&&this.set(e)}},e.prototype.didRecohere=function(t){},e.prototype.memoize=function(){return this},e.prototype.map=function(t){var e=new h.MapValueCombinator(t);return e.bindInput(this),e},e.prototype.watch=function(t){return new h.WatchValueCombinator(t).bindInput(this),this},e}(T),H=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return p(e,t),e}(u.AbstractRecordOutlet),z=function(t){function e(e){var o=t.call(this)||this;return o._downlink=e,o}return p(e,t),Object.defineProperty(e.prototype,"downlink",{get:function(){return this._downlink},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){return this._downlink.isEmpty()},e.prototype.isArray=function(){return!0},e.prototype.isObject=function(){return this._downlink.isEmpty()},Object.defineProperty(e.prototype,"length",{get:function(){return this._downlink.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._downlink.length},enumerable:!1,configurable:!0}),e.prototype.has=function(t){return!1},e.prototype.get=function(t){return void 0===t?this:r.Value.absent()},e.prototype.getAttr=function(t){return r.Value.absent()},e.prototype.getSlot=function(t){return r.Value.absent()},e.prototype.getItem=function(t){t instanceof r.Num&&(t=t.value);var e=this._downlink.length;return t<0&&(t=e+t),(t=Math.min(Math.max(0,t),e-1))>=0?this._downlink.get(t):r.Item.absent()},e.prototype.set=function(t,e){throw new Error("unsupported")},e.prototype.setAttr=function(t,e){throw new Error("unsupported")},e.prototype.setSlot=function(t,e){throw new Error("unsupported")},e.prototype.setItem=function(t,e){t instanceof r.Num&&(t=t.value);var o=this._downlink.length;return t<0&&(t=o+t),(t=Math.min(Math.max(0,t),o-1))>=0&&this._downlink.set(t,r.Value.fromAny(e)),this},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this._downlink.push.apply(this._downlink,arguments)},e.prototype.splice=function(t,e){for(var o=[],i=2;i<arguments.length;i++)o[i-2]=arguments[i];return this._downlink.splice.apply(this._downlink,arguments)},e.prototype.delete=function(t){return r.Item.absent()},e.prototype.clear=function(){this._downlink.clear()},e.prototype.forEach=function(t,e){return this._downlink.forEach((function(o,i){return t.call(e,o,i)}))},e.prototype.keyIterator=function(){return i.Cursor.empty()},e}(H),N=function(t){function e(e){var o=t.call(this)||this;return o._downlink=e,o._downlink.observe(o),o}return p(e,t),Object.defineProperty(e.prototype,"downlink",{get:function(){return this._downlink},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){return this._downlink.isEmpty()},e.prototype.isArray=function(){return this._downlink.isEmpty()},e.prototype.isObject=function(){return!0},Object.defineProperty(e.prototype,"length",{get:function(){return this._downlink.size},enumerable:!1,configurable:!0}),e.prototype.has=function(t){return this._downlink.has(t)},e.prototype.get=function(t){return void 0===t?this:this._downlink.get(t)},e.prototype.getAttr=function(t){return r.Value.absent()},e.prototype.getSlot=function(t){return this.get(t)},e.prototype.getItem=function(t){t instanceof r.Num&&(t=t.value);var e=this._downlink.size;if(t<0&&(t=e+t),(t=Math.min(Math.max(0,t),e-1))>=0){var o=this._downlink.getEntry(t);return r.Slot.of(o[0],o[1])}return r.Item.absent()},e.prototype.set=function(t,e){return this._downlink.set(t,e),this},e.prototype.setAttr=function(t,e){throw new Error("unsupported")},e.prototype.setSlot=function(t,e){return this.set(t,e)},e.prototype.setItem=function(t,e){throw new Error("unsupported")},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];throw new Error("unsupported")},e.prototype.splice=function(t,e){for(var o=[],i=2;i<arguments.length;i++)o[i-2]=arguments[i];throw new Error("unsupported")},e.prototype.delete=function(t){t=r.Value.fromAny(t);var e=this._downlink.get(t);return this._downlink.delete(t)?r.Slot.of(t,e):r.Item.absent()},e.prototype.clear=function(){this._downlink.clear()},e.prototype.forEach=function(t,e){var o=0;return this._downlink.forEach((function(i,n){var s=t.call(e,r.Slot.of(i,n),o);return o+=1,s}))},e.prototype.keyIterator=function(){return this._downlink.keys()},e.prototype.didUpdate=function(t,e,o){this.decohereInputKey(t,0),this.recohereInput(0)},e.prototype.didRemove=function(t,e){this.decohereInputKey(t,1),this.recohereInput(0)},e.prototype.didDrop=function(t){},e.prototype.didTake=function(t){},e.prototype.didClear=function(){},e}(H),G=function(t){function e(e){var o=t.call(this)||this;return o._downlink=e,o._downlink.observe(o),o}return p(e,t),Object.defineProperty(e.prototype,"downlink",{get:function(){return this._downlink},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){var t=this._downlink.get();return t instanceof r.Record?t.isEmpty():!t.isDefined()},e.prototype.isArray=function(){var t=this._downlink.get();return!(t instanceof r.Record)||t.isArray()},e.prototype.isObject=function(){var t=this._downlink.get();return t instanceof r.Record?t.isObject():!t.isDefined()},Object.defineProperty(e.prototype,"length",{get:function(){var t=this._downlink.get();return t instanceof r.Record?t.length:t.isDefined()?1:0},enumerable:!1,configurable:!0}),e.prototype.has=function(t){var e=this._downlink.get();return e instanceof r.Record&&e.has(t)},e.prototype.get=function(t){if(void 0===t)return this;var e=this._downlink.get();return e instanceof r.Record?e.get(t):r.Value.absent()},e.prototype.getAttr=function(t){var e=this._downlink.get();return e instanceof r.Record?e.getAttr(t):r.Value.absent()},e.prototype.getSlot=function(t){var e=this._downlink.get();return e instanceof r.Record?e.getSlot(t):r.Value.absent()},e.prototype.getField=function(t){var e=this._downlink.get();return e instanceof r.Record?e.getField(t):void 0},e.prototype.getItem=function(t){var e=this._downlink.get();return e instanceof r.Record?e.getItem(t):e},e.prototype.set=function(t,e){var o=this._downlink.get();if(!(o instanceof r.Record))throw new Error("unsupported");return o.set(t,e),this},e.prototype.setAttr=function(t,e){var o=this._downlink.get();if(!(o instanceof r.Record))throw new Error("unsupported");return o.setAttr(t,e),this},e.prototype.setSlot=function(t,e){var o=this._downlink.get();if(!(o instanceof r.Record))throw new Error("unsupported");return o.setSlot(t,e),this},e.prototype.setItem=function(t,e){var o=this._downlink.get();return o instanceof r.Record?o.setItem(t,e):this._downlink.set(r.Item.fromAny(e).toValue()),this},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this._downlink.get();if(o instanceof r.Record)return o.push.apply(o,arguments);throw new Error("unsupported")},e.prototype.splice=function(t,e){for(var o=[],i=2;i<arguments.length;i++)o[i-2]=arguments[i];var n=this._downlink.get();if(n instanceof r.Record)return n.splice.apply(n,arguments);throw new Error("unsupported")},e.prototype.delete=function(t){var e=this._downlink.get();return e instanceof r.Record?e.delete(t):r.Value.absent()},e.prototype.clear=function(){var t=this._downlink.get();if(!(t instanceof r.Record))throw new Error("unsupported");t.clear()},e.prototype.forEach=function(t,e){return this._downlink.get().forEach(t,e)},e.prototype.keyIterator=function(){if(this._downlink.get()instanceof r.Record)throw new Error;return i.Cursor.empty()},e.prototype.didSet=function(t,e){this.decohereInput(),this.recohereInput(0)},e}(H),J=function(t){function e(e){var o=t.call(this)||this;return o.warp=e,o}return p(e,t),e.prototype.reify=function(t){return t instanceof r.Field?this.reifyField(t):this.reifyValue(t)},e.prototype.reifyField=function(t){var e=t.value,o=this.reifyValue(e);return e!==o?t.updatedValue(o):t},e.prototype.reifyValue=function(t){return t instanceof u.RecordModel?this.reifyModel(t):t},e.prototype.reifyModel=function(t){if("link"===t.tag()){var e=new Q(this.warp,t);return e.compile(),e}return t},e}(u.Reifier),Q=function(t){function e(e,o){var i=t.call(this,o)||this;return i.hostUri=i.inoutlet(),i.nodeUri=i.inoutlet(),i.laneUri=i.inoutlet(),i.prio=i.inoutlet(),i.rate=i.inoutlet(),i.bodyValue=i.inoutlet(),i.type=i.inoutlet(),i.warp=e,i}return p(e,t),e.prototype.getOutput=function(t){if((t=this.outlet(t))===this.state){if(this.downlink instanceof P)return this.downlink.get();if(void 0!==this.downlinkRecord)return this.downlinkRecord}},e.prototype.onRecohere=function(t){var e=this.castInput(this.hostUri,r.Form.forString()),o=this.castInput(this.nodeUri,r.Form.forString()),i=this.castInput(this.laneUri,r.Form.forString()),n=this.castInput(this.prio,r.Form.forNumber(),0),s=this.castInput(this.rate,r.Form.forNumber(),0),h=this.getInput(this.bodyValue),u=this.castInput(this.type,r.Form.forString(),void 0);if(e!==this.inputHostUri||o!==this.inputNodeUri||i!==this.inputLaneUri||n!==this.inputPrio||s!==this.inputRate||(void 0===h?void 0!==this.inputBody:!h.equals(this.inputBody))||u!==this.inputType){void 0!==this.downlink&&(this.downlink.close(),this.downlink=void 0,this.downlinkRecord=void 0),this.inputHostUri=e,this.inputNodeUri=o,this.inputLaneUri=i,this.inputPrio=n,this.inputRate=s,this.inputBody=h,this.inputType=u;var l=this.warp||et;if("map"===u){var a=l.downlinkMap();void 0!==e&&(a=a.hostUri(e)),void 0!==o&&(a=a.nodeUri(o)),void 0!==i&&(a=a.laneUri(i)),0!==n&&(a=a.prio(n)),0!==s&&(a=a.rate(s)),void 0!==h&&(a=a.body(h)),a=a.open(),this.state=a,this.downlink=a,this.downlinkRecord=new N(a)}else if("value"===u){a=l.downlinkValue();void 0!==e&&(a=a.hostUri(e)),void 0!==o&&(a=a.nodeUri(o)),void 0!==i&&(a=a.laneUri(i)),void 0!==n&&(a=a.prio(n)),void 0!==s&&(a=a.rate(s)),void 0!==h&&(a=a.body(h)),a=a.open(),this.state=a,this.downlink=a}}},e.reifier=function(t){return void 0===t?(void 0===e._reifier&&(e._reifier=new J),e._reifier):new J(t)},d([h.Inout],e.prototype,"hostUri",void 0),d([h.Inout],e.prototype,"nodeUri",void 0),d([h.Inout],e.prototype,"laneUri",void 0),d([h.Inout],e.prototype,"prio",void 0),d([h.Inout],e.prototype,"rate",void 0),d([h.Inout("body")],e.prototype,"bodyValue",void 0),d([h.Inout],e.prototype,"type",void 0),d([h.Out],e.prototype,"state",void 0),e}(u.AbstractRecordStreamlet),X=function(){function t(t){this._context=t,this._host=void 0,this._downlinks=[],this._observers=null}return t.prototype.isConnected=function(){return void 0!==this._host&&this._host.isConnected()},t.prototype.isAuthenticated=function(){return void 0!==this._host&&this._host.isAuthenticated()},t.prototype.session=function(){return void 0!==this._host?this._host.session():r.Value.absent()},t.prototype.authenticate=function(t){this._context.authenticate(this.hostUri(),t)},t.prototype.addDownlink=function(t){0===this._downlinks.length&&this.open(),this._downlinks.push(t)},t.prototype.removeDownlink=function(t){var e=this._downlinks.indexOf(t);e>=0&&(this._downlinks.splice(e,1),0===this._downlinks.length&&this.close())},t.prototype.open=function(){this._context.openRef(this)},t.prototype.close=function(){this._context.closeRef(this)},t.prototype.closeUp=function(){var t=this._downlinks;this._downlinks=[];for(var e=0,o=t.length;e<o;e+=1)t[e].close()},t.prototype.observe=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=new Array(o+1),n=0;n<o;n+=1)i[n]=e[n];return i[o]=t,this._observers=i,this},t.prototype.unobserve=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i],r=n===t;if(!r)for(var s in n)if(n[s]===t){r=!0;break}if(r){if(o>1){for(var h=new Array(o-1),u=0;u<i;u+=1)h[u]=e[u];for(u=i+1;u<o;u+=1)h[u-1]=e[u];this._observers=h}else this._observers=null;break}}return this},t.prototype.didConnect=function(t){return this.observe({didConnect:t})},t.prototype.didAuthenticate=function(t){return this.observe({didAuthenticate:t})},t.prototype.didDeauthenticate=function(t){return this.observe({didDeauthenticate:t})},t.prototype.didDisconnect=function(t){return this.observe({didDisconnect:t})},t.prototype.didFail=function(t){return this.observe({didFail:t})},t.prototype.hostDidConnect=function(t){this._host=t;for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didConnect&&n.didConnect(t,this)}},t.prototype.hostDidAuthenticate=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didAuthenticate&&r.didAuthenticate(t,e,this)}},t.prototype.hostDidDeauthenticate=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didDeauthenticate&&r.didDeauthenticate(t,e,this)}},t.prototype.hostDidDisconnect=function(t){this._host=void 0;for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didDisconnect&&n.didDisconnect(t,this)}},t.prototype.hostDidFail=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didFail&&r.didFail(t,e,this)}},t}(),Y=function(t){function e(e,o,i,n){var r=t.call(this,e)||this;return r._hostUri=o,r._nodeUri=i,r._laneUri=n,r}return p(e,t),e.prototype.hostUri=function(){return this._hostUri},e.prototype.nodeUri=function(){return this._nodeUri},e.prototype.laneUri=function(){return this._laneUri},e.prototype.hostRef=function(t){return t=n.Uri.fromAny(t),new $(this._context,t)},e.prototype.nodeRef=function(t){return t=n.Uri.fromAny(t),new Z(this._context,this._hostUri,t)},e.prototype.laneRef=function(t){return t=n.Uri.fromAny(t),new e(this._context,this._hostUri,this._nodeUri,t)},e.prototype.downlink=function(t){return new W(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},e.prototype.downlinkList=function(t){return new L(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},e.prototype.downlinkMap=function(t){return new j(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},e.prototype.downlinkValue=function(t){return new P(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},e.prototype.command=function(t){this._context.command(this._hostUri,this._nodeUri,this._laneUri,t)},e}(X),Z=function(t){function e(e,o,i){var n=t.call(this,e)||this;return n._hostUri=o,n._nodeUri=i,n}return p(e,t),e.prototype.hostUri=function(){return this._hostUri},e.prototype.nodeUri=function(){return this._nodeUri},e.prototype.hostRef=function(t){return t=n.Uri.fromAny(t),new $(this._context,t)},e.prototype.nodeRef=function(t){return t=n.Uri.fromAny(t),new e(this._context,this._hostUri,t)},e.prototype.laneRef=function(t){return t=n.Uri.fromAny(t),new Y(this._context,this._hostUri,this._nodeUri,t)},e.prototype.downlink=function(t){return new W(this._context,this,t,this._hostUri,this._nodeUri)},e.prototype.downlinkList=function(t){return new L(this._context,this,t,this._hostUri,this._nodeUri)},e.prototype.downlinkMap=function(t){return new j(this._context,this,t,this._hostUri,this._nodeUri)},e.prototype.downlinkValue=function(t){return new P(this._context,this,t,this._hostUri,this._nodeUri)},e.prototype.command=function(t,e){this._context.command(this._hostUri,this._nodeUri,t,e)},e}(X),$=function(t){function e(e,o){var i=t.call(this,e)||this;return i._hostUri=o,i}return p(e,t),e.prototype.hostUri=function(){return this._hostUri},e.prototype.hostRef=function(t){return t=n.Uri.fromAny(t),new e(this._context,t)},e.prototype.nodeRef=function(t){return t=n.Uri.fromAny(t),new Z(this._context,this._hostUri,t)},e.prototype.laneRef=function(t,e){return t=n.Uri.fromAny(t),e=n.Uri.fromAny(e),new Y(this._context,this._hostUri,t,e)},e.prototype.downlink=function(t){return new W(this._context,this,t,this._hostUri)},e.prototype.downlinkList=function(t){return new L(this._context,this,t,this._hostUri)},e.prototype.downlinkMap=function(t){return new j(this._context,this,t,this._hostUri)},e.prototype.downlinkValue=function(t){return new P(this._context,this,t,this._hostUri)},e.prototype.command=function(t,e,o){this._context.command(this._hostUri,t,e,o)},e}(X),tt=function(){function t(t){void 0===t&&(t={}),void 0===t.keepOnline&&(t.keepOnline=!0),this._options=t,this._hosts=new s.BTree,this._downlinks=new s.BTree,this._downlinkCount=0,this._refs=[],this._online=!0,this._observers=null,this.onOnline=this.onOnline.bind(this),this.onOffline=this.onOffline.bind(this),this.watchOnline(!!t.keepOnline)}return t.prototype.isOnline=function(t){return void 0===t?this._online:(this._online!==t&&(this._online=t,t&&this._hosts.forEach((function(t,e){e.open()}),this)),this)},t.prototype.keepOnline=function(t){return void 0===t?!!this._options.keepOnline:(this._options.keepOnline!==t&&(this._options.keepOnline=t,this.watchOnline(t)),this)},t.prototype.watchOnline=function(t){"object"==typeof window&&(t?(window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)):(window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)))},t.prototype.onOnline=function(t){this.isOnline(!0)},t.prototype.onOffline=function(t){this.isOnline(!1)},t.prototype.getHost=function(t){return t=n.Uri.fromAny(t),this._hosts.get(t)},t.prototype.openHost=function(t){t=n.Uri.fromAny(t);var e=this._hosts.get(t);return void 0===e&&(e=new M(this,t,this._options),this._hosts.set(t,e)),e},t.prototype.closeHost=function(t){void 0!==this._hosts.get(t.hostUri())&&(this._hosts.delete(t.hostUri()),t.closeUp())},t.prototype.getDownlink=function(t,e,o){var i=this._downlinks.get(t);if(void 0!==i){var n=i.get(e);if(void 0!==n)return n.get(o)}},t.prototype.openDownlink=function(t){var e=t.hostUri(),o=t.nodeUri(),i=t.laneUri(),n=this._downlinks.get(e);void 0===n&&(n=new s.BTree,this._downlinks.set(e,n));var r=n.get(o);if(void 0===r&&(r=new s.BTree,n.set(o,r)),r.has(i))throw new Error("duplicate downlink");r.set(i,t),this._downlinkCount+=1,this.openHost(e).openDownlink(t)},t.prototype.unlinkDownlink=function(t){var e=t.hostUri(),o=this.getHost(e);void 0!==o&&o.unlinkDownlink(t)},t.prototype.closeDownlink=function(t){var e=t.hostUri(),o=t.nodeUri(),i=t.laneUri(),n=this._downlinks.get(e);if(void 0!==n){var r=n.get(o);if(void 0!==r&&r.get(i)){this._downlinkCount-=1,r.delete(i),r.isEmpty()&&(n.delete(o),n.isEmpty()&&this._downlinks.delete(e));var s=this.getHost(e);void 0!==s&&s.closeDownlink(t)}}},t.prototype.downlink=function(t){return new W(this,void 0,t)},t.prototype.downlinkList=function(t){return new L(this,void 0,t)},t.prototype.downlinkMap=function(t){return new j(this,void 0,t)},t.prototype.downlinkValue=function(t){return new P(this,void 0,t)},t.prototype.openRef=function(t){this._refs.push(t)},t.prototype.closeRef=function(t){var e=this._refs.indexOf(t);e>=0&&(this._refs.splice(e,1),t.closeUp())},t.prototype.hostRef=function(t){return t=n.Uri.fromAny(t),new $(this,t)},t.prototype.nodeRef=function(t,e){return t=n.Uri.fromAny(t),void 0===e?(t=(e=t).endpoint(),e=t.unresolve(e)):e=n.Uri.fromAny(e),new Z(this,t,e)},t.prototype.laneRef=function(t,e,o){return t=n.Uri.fromAny(t),e=n.Uri.fromAny(e),void 0===o?(o=e,t=(e=t).endpoint(),e=t.unresolve(e)):o=n.Uri.fromAny(o),new Y(this,t,e,o)},t.prototype.authenticate=function(t,e){t=n.Uri.fromAny(t),e=r.Value.fromAny(e),this.openHost(t).authenticate(e)},t.prototype.command=function(t,e,o,i){t=n.Uri.fromAny(t),e=n.Uri.fromAny(e),3===arguments.length?(i=o,o=e,t=(e=t).endpoint(),e=t.unresolve(e)):o=n.Uri.fromAny(o),i=r.Value.fromAny(i);var s=this.openHost(t);s.command(e,o,i)},t.prototype.close=function(){var t=this._refs;this._refs=[];for(var e=0;e<t.length;e+=1)t[e].closeUp();var o=this._downlinks.clone();this._downlinks.clear(),this._downlinkCount=0,o.forEach((function(t,e){e.forEach((function(e,o){o.forEach((function(e,o){o.closeUp();var i=this.getHost(t);void 0!==i&&i.closeDownlink(o)}),this)}),this)}),this);var i=this._hosts.clone();this._hosts.clear(),i.forEach((function(t,e){e.closeUp()}),this)},t.prototype.observe=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=new Array(o+1),n=0;n<o;n+=1)i[n]=e[n];return i[o]=t,this._observers=i,this},t.prototype.unobserve=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i],r=n===t;if(!r)for(var s in n)if(n[s]===t){r=!0;break}if(r){if(o>1){for(var h=new Array(o-1),u=0;u<i;u+=1)h[u]=e[u];for(u=i+1;u<o;u+=1)h[u-1]=e[u];this._observers=h}else this._observers=null;break}}return this},t.prototype.didConnect=function(t){return this.observe({didConnect:t})},t.prototype.didAuthenticate=function(t){return this.observe({didAuthenticate:t})},t.prototype.didDeauthenticate=function(t){return this.observe({didDeauthenticate:t})},t.prototype.didDisconnect=function(t){return this.observe({didDisconnect:t})},t.prototype.didFail=function(t){return this.observe({didFail:t})},t.prototype.hostDidConnect=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didConnect&&n.didConnect(t,this)}for(i=0;i<this._refs.length;i+=1){var r=this._refs[i];r.hostUri().equals(t.hostUri())&&r.hostDidConnect(t)}},t.prototype.hostDidAuthenticate=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didAuthenticate&&r.didAuthenticate(t,e,this)}for(n=0;n<this._refs.length;n+=1){var s=this._refs[n];s.hostUri().equals(e.hostUri())&&s.hostDidAuthenticate(t,e)}},t.prototype.hostDidDeauthenticate=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didDeauthenticate&&r.didDeauthenticate(t,e,this)}for(n=0;n<this._refs.length;n+=1){var s=this._refs[n];s.hostUri().equals(e.hostUri())&&s.hostDidDeauthenticate(t,e)}},t.prototype.hostDidDisconnect=function(t){for(var e=this._observers,o=null!==e?e.length:0,i=0;i<o;i+=1){var n=e[i];void 0!==n.didDisconnect&&n.didDisconnect(t,this)}for(i=0;i<this._refs.length;i+=1){var r=this._refs[i];r.hostUri().equals(t.hostUri())&&r.hostDidDisconnect(t)}},t.prototype.hostDidFail=function(t,e){for(var o=this._observers,i=null!==o?o.length:0,n=0;n<i;n+=1){var r=o[n];void 0!==r.didFail&&r.didFail(t,e,this)}for(n=0;n<this._refs.length;n+=1){var s=this._refs[n];s.hostUri().equals(e.hostUri())&&s.hostDidFail(t,e)}},t}(),et=new tt,ot=et.isOnline.bind(et),it=et.keepOnline.bind(et),nt=et.downlink.bind(et),rt=et.downlinkList.bind(et),st=et.downlinkMap.bind(et),ht=et.downlinkValue.bind(et),ut=et.hostRef.bind(et),lt=et.nodeRef.bind(et),at=et.laneRef.bind(et),pt=et.authenticate.bind(et),dt=et.command.bind(et);t.AuthRequest=R,t.AuthedResponse=V,t.BaseRef=X,t.CommandMessage=m,t.DeauthRequest=E,t.DeauthedResponse=F,t.Downlink=T,t.DownlinkModel=x,t.DownlinkRecord=H,t.DownlinkReifier=J,t.DownlinkStreamlet=Q,t.Envelope=l,t.EventDownlink=W,t.EventDownlinkModel=I,t.EventMessage=y,t.Host=A,t.HostAddressed=f,t.HostRef=$,t.LaneAddressed=v,t.LaneRef=Y,t.LinkAddressed=_,t.LinkRequest=w,t.LinkedResponse=k,t.ListDownlink=L,t.ListDownlinkModel=q,t.ListDownlinkRecord=z,t.MapDownlink=j,t.MapDownlinkModel=K,t.MapDownlinkRecord=N,t.NodeRef=Z,t.RemoteHost=S,t.SyncRequest=g,t.SyncedResponse=b,t.UnlinkRequest=U,t.UnlinkedResponse=D,t.ValueDownlink=P,t.ValueDownlinkModel=B,t.ValueDownlinkRecord=G,t.WarpClient=tt,t.WebSocketHost=M,t.authenticate=pt,t.client=et,t.command=dt,t.downlink=nt,t.downlinkList=rt,t.downlinkMap=st,t.downlinkValue=ht,t.hostRef=ut,t.isOnline=ot,t.keepOnline=it,t.laneRef=at,t.nodeRef=lt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=swim-mesh.min.js.map